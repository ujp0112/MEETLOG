# MEETLOG ê¸°ëŠ¥ ê°œì„  êµ¬í˜„ ê³„íš (v2.0)

## 0. í™˜ê²½ ë° í”„ë¡œì íŠ¸ êµ¬ì¡°

### 0.1 ê°œë°œ í™˜ê²½ ìš”ì•½
- **OS**: macOS (ê²½ë¡œ `/Users/sangwoolee/...` ê¸°ë°˜)
- **Shell**: `zsh`
- **ì£¼ìš” ëŸ°íƒ€ì„**: Java 11 (Maven ë¹Œë“œ, Eclipse Tomcat 9), Python 3.13 (KoBERT API)
- **ì„œë²„**: ë¡œì»¬ Tomcat 9 (`MeetLog/Servers/Tomcat v9.0 Server at localhost-config`)
- **í”„ë¡ íŠ¸ì—”ë“œ**: JSP + JSTL, Tailwind CDN ì‚¬ìš©
- **DB**: MariaDB 10.x (`database/master.sql` ìŠ¤í‚¤ë§ˆ ê¸°ì¤€, `root:7564@localhost:3306/meetlog`)
- **ì¶”ê°€ ì„œë¹„ìŠ¤**: `kobert-api-server` (Python/FastAPI)ë¡œ ì¶”ì²œ API ì œê³µ

### 0.2 ì£¼ìš” ë””ë ‰í„°ë¦¬ êµ¬ì¡°
```
MEETLOG/
â”œâ”€ MeetLog/                  # ë©”ì¸ Java ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜
â”‚  â”œâ”€ pom.xml                # Maven í”„ë¡œì íŠ¸ ì„¤ì •
â”‚  â”œâ”€ src/
â”‚  â”‚  â”œâ”€ main/java/          # Servlet, Service, DAO, Model ë“± Java ì†ŒìŠ¤
â”‚  â”‚  â”œâ”€ main/resources/     # MyBatis ë§¤í¼, ì„¤ì • íŒŒì¼
â”‚  â”‚  â””â”€ main/webapp/        # JSP, ì •ì  ë¦¬ì†ŒìŠ¤
â”‚  â”œâ”€ target/                # ë¹Œë“œ ì‚°ì¶œë¬¼
â”‚  â””â”€ Servers/               # ë¡œì»¬ Tomcat ì„¤ì •
â”œâ”€ kobert-api-server/        # ë¦¬ë·° ë²¡í„°í™” FastAPI ì„œë²„
â”œâ”€ database/                 # SQL ìŠ¤í‚¤ë§ˆ & ìƒ˜í”Œ ë°ì´í„°
â”œâ”€ meetlog_uploads/          # ì—…ë¡œë“œ ìì‚° (ì´ë¯¸ì§€ ë“±)
â””â”€ ê¸°íƒ€ ë¬¸ì„œ (README, todo_list, CLAUDE.md ë“±)
```

#### MeetLog/src/main/java
- `controller/` : Servlet ê³„ì¸µ (ì˜ˆì•½, ê²°ì œ, ì¿ í°, ë§ˆì´í˜ì´ì§€ ë“±)
- `service/` : ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (ReservationService, CouponService, PointService ë“±)
- `dao/` : MyBatis DAO (`ReservationDAO`, `UserCouponDAO`, `PointDAO` ë“±)
- `model/` : POJO ë„ë©”ì¸ ê°ì²´ (`Reservation`, `Coupon`, `User`, `Point` ë“±)
- `dto/`, `adapter/` : ë·°/ì™¸ë¶€ ì—°ë™ìš© DTO ë° ì–´ëŒ‘í„°
- `erpController/`, `erpService/`, `erpDto/` : ERP ëª¨ë“ˆ ê´€ë ¨ ì„œë¸Œ íŒ¨í‚¤ì§€
- `util/`, `typehandler/`, `filter/` : ê³µìš© ìœ í‹¸ë¦¬í‹°, MyBatis íƒ€ì… í•¸ë“¤ëŸ¬, ì„œë¸”ë¦¿ í•„í„°

#### MeetLog/src/main/resources
- `mappers/` : MyBatis ë§¤í¼ XML (`ReservationMapper.xml`, `CouponMapper.xml`, `UserCouponMapper.xml`, `PointMapper.xml` ë“±)
- `mybatis-config.xml` : ì „ì—­ MyBatis ì„¤ì •
- `config.properties`, `api.properties`, `db.properties` : ëŸ°íƒ€ì„ ì„¤ì • íŒŒì¼

#### MeetLog/src/main/webapp
- `WEB-INF/views/` : JSP ë·° (`mypage`, `coupon-management`, `business`, `erp`, `reservation` ë“±)
- `WEB-INF/web.xml` : ì„œë¸”ë¦¿ ë§¤í•‘
- `css/`, `js/`, `assets/` : ì •ì  ìì›

#### ê¸°íƒ€
- `kobert-api-server/`
  - `main.py`, `routers/`, `services/`: KoBERT ì¶”ì²œ API (FastAPI + PyTorch)
  - `vectorizer/`: ì„ë² ë”© ë¡œì§, `venv/` ê°€ìƒí™˜ê²½
- `database/`
  - `master.sql`, `semi-erp.sql` ë“± ìŠ¤í‚¤ë§ˆ ë° ìƒ˜í”Œ ë°ì´í„°
  - `archive/`: ê³¼ê±° ë¤í”„
- `meetlog_uploads/`: ì—…ë¡œë“œëœ ì´ë¯¸ì§€Â·íŒŒì¼ ì €ì¥ì†Œ

---

## 1. ê°œìš”
- **ì‘ì„± ëª©ì **: ì¿ í° ê¸°ëŠ¥ ê³ ë„í™” ë° ì‹ ê·œ í¬ì¸íŠ¸ ì‹œìŠ¤í…œ ë„ì…, í…”ë ˆê·¸ë¨ ì•Œë¦¼ ì—°ë™ì— í•„ìš”í•œ ê°œë°œ ë²”ìœ„, ì„ í–‰ ì‘ì—…, ê²€ì¦ ê³„íšì„ ëª…í™•íˆ í•˜ê³  ì‹¤ë¬´ íˆ¬ì… ê°€ëŠ¥í•œ ìˆ˜ì¤€ì˜ ìƒì„¸ êµ¬í˜„ ê°€ì´ë“œë¥¼ ì œê³µí•œë‹¤.
- **ì‘ì„± ê¸°ì¤€ ì†ŒìŠ¤**: `MeetLog` ëª¨ë†€ë¦¬ì‹ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ (Java Servlet + JSP, MyBatis)
- **ëª©í‘œ**: ê° ê¸°ëŠ¥ë³„ë¡œ **ìˆ˜ì •í•  íŒŒì¼ ëª©ë¡**, **í•µì‹¬ ì½”ë“œ ìŠ¤ë‹ˆí«**, **ë¡¤ë°±/ì—ëŸ¬ ì²˜ë¦¬ ì‹œë‚˜ë¦¬ì˜¤**ê¹Œì§€ í¬í•¨í•œ ì™„ì„±ë„ ë†’ì€ êµ¬í˜„ ê³„íš ìˆ˜ë¦½

---

## 2. ì¿ í° ê¸°ëŠ¥ ê°œì„ 

### 2.1 í˜„í™© ìš”ì•½
- **í˜„ì¬ êµ¬í˜„ ìƒíƒœ**:
  - ì¿ í° ì •ë³´: `model/Coupon`, `CouponMapper.xml`ì„ í†µí•´ ë°œê¸‰/ì¡°íšŒ/ìˆ˜ì •ê¹Œì§€ ì§€ì›
  - ì‚¬ìš©ì ì¿ í°: `model/UserCoupon` + `UserCouponMapper.xml`ë¡œ ì‚¬ìš©ìë³„ ì§€ê¸‰Â·ì‚¬ìš© ì—¬ë¶€ ê´€ë¦¬
  - ê´€ë¦¬ì í”Œë¡œìš°: `CouponCreateServlet`, `CouponManagementServlet`ì—ì„œ ìƒì„±/ìˆ˜ì •/ë¹„í™œì„±í™” ì²˜ë¦¬
  - ì‚¬ìš©ì í”Œë¡œìš°: `RestaurantDetailServlet` ë…¸ì¶œ, `MypageServlet`ì—ì„œ ì‚¬ìš© ì²˜ë¦¬ (`user_coupons.is_used`ë§Œ ê°±ì‹ )

- **ë¯¸ë¹„ì  (Critical Issues)**
  1. âŒ `coupons.usage_count`ê°€ ì¦ê°€í•˜ì§€ ì•Šì•„ `usage_limit`ì´ ë¬´ì˜ë¯¸í•¨
  2. âŒ `per_user_limit`, ìœ íš¨ê¸°ê°„, ìµœì†Œì£¼ë¬¸ê¸ˆì•¡ ê²€ì¦ì´ í´ë¼ì´ì–¸íŠ¸ ì˜ì¡´ (ì„œë²„ ê²€ì¦ ë¶€ì¬)
  3. âŒ ì¿ í° ì§€ê¸‰ ë¡œì§ ë¶€ì¬ (`UserCouponService.giveCouponToUser` ë¯¸ì‚¬ìš©)
  4. âŒ **ê²°ì œ/ì˜ˆì•½ ë¡œì§ê³¼ ë¯¸ì—°ë™** (ì‹¤ì œ ì •ì‚° ê¸ˆì•¡ì— ë°˜ì˜ë˜ì§€ ì•ŠìŒ)
  5. âŒ ê²°ì œ ì‹¤íŒ¨ ì‹œ ì¿ í° ë¡¤ë°± ë¡œì§ ì—†ìŒ

### 2.2 ê°œì„  ëª©í‘œ
1. **ì¿ í° ì‚¬ìš© ë¡œê¹… ê°•í™”**
   - ì¿ í° ì‚¬ìš© ì‹œ `coupons.usage_count` ì¦ê°€ ë° ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ ì¬ê²€ì¦
   - `per_user_limit`, `valid_from/valid_to`, `min_order_amount`ë¥¼ ì„œë²„ì—ì„œ í•„ìˆ˜ ì²´í¬
   - ì‚¬ìš©ì ì„¸ì…˜ ê²€ì¦ (ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ì¿ í° ì‚¬ìš© ë°©ì§€)

2. **ì¿ í° ì§€ê¸‰/íšŒìˆ˜ API í™•ì¥**
   - ì´ë²¤íŠ¸Â·ë§ˆì¼€íŒ…ì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” ì§€ê¸‰ ì„œë¹„ìŠ¤ (`UserCouponService.giveCouponToUser` ê°œì„  ë° ë…¸ì¶œ)
   - ê´€ë¦¬ì ìˆ˜ë™ ì§€ê¸‰/íšŒìˆ˜ í™”ë©´ (ì„ íƒ êµ¬í˜„)

3. **ì˜ˆì•½Â·ê²°ì œ ì—°ê³„ (í•µì‹¬)**
   - `ReservationServlet`ì—ì„œ ì¿ í° ì„ íƒ â†’ ì£¼ë¬¸ ê¸ˆì•¡ í• ì¸ ê³„ì‚°
   - `NaverPayService`ì˜ depositAmountì—ì„œ í• ì¸ ë°˜ì˜
   - ê²°ì œ ì„±ê³µ/ì‹¤íŒ¨ ì‹œ ì¿ í° ìƒíƒœ ë¡¤ë°± ì²˜ë¦¬

### 2.3 ë°ì´í„° ëª¨ë¸ ë° ì²˜ë¦¬ ë³´ê°•

#### 2.3.1 DB ìŠ¤í‚¤ë§ˆ ì¶”ê°€/ìˆ˜ì •
```sql
-- ì˜ˆì•½-ì¿ í° ë§¤í•‘ (reservations í…Œì´ë¸”ì— FK ì¶”ê°€)
ALTER TABLE reservations
  ADD COLUMN user_coupon_id BIGINT NULL AFTER deposit_amount,
  ADD COLUMN coupon_discount_amount DECIMAL(10,2) DEFAULT 0 AFTER user_coupon_id,
  ADD CONSTRAINT fk_reservations_user_coupon
    FOREIGN KEY (user_coupon_id) REFERENCES user_coupons(id) ON DELETE SET NULL;

-- ì¤‘ë³µ ì§€ê¸‰ ë°©ì§€ ì¸ë±ìŠ¤ (ë‹¨ì¼ ì¿ í°ì¸ ê²½ìš°)
ALTER TABLE user_coupons
  ADD UNIQUE INDEX ux_user_coupon_single (user_id, coupon_id, is_used);
  -- is_used=0ì¼ ë•Œë§Œ ìœ ë‹ˆí¬ ì œì•½ ì ìš© (MySQL 8.0+ partial index ë˜ëŠ” íŠ¸ë¦¬ê±°ë¡œ ëŒ€ì²´)

-- ì¿ í° ì‚¬ìš© ë¡œê·¸ í…Œì´ë¸” (ì„ íƒ ì‚¬í•­ - ìƒì„¸ ì´ë ¥ ì¶”ì ìš©)
CREATE TABLE IF NOT EXISTS coupon_usage_logs (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_coupon_id BIGINT NOT NULL,
  reservation_id INT NULL,
  action ENUM('USE', 'ROLLBACK') NOT NULL,
  discount_amount DECIMAL(10,2) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_coupon_id) REFERENCES user_coupons(id),
  FOREIGN KEY (reservation_id) REFERENCES reservations(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 2.3.2 ì‚¬ìš© ì œí•œ ê²€ì¦ ë¡œì§
- **ì„œë²„ ì¸¡ ê²€ì¦ í•„ìˆ˜ í•­ëª©**:
  1. `coupon.is_active = true` í™•ì¸
  2. `coupon.valid_from <= NOW() <= coupon.valid_to` í™•ì¸
  3. `coupon.usage_count < coupon.usage_limit` í™•ì¸
  4. `user_coupons.is_used = false` í™•ì¸
  5. í•´ë‹¹ ì‚¬ìš©ìê°€ ì´ë¯¸ `per_user_limit`ë§Œí¼ ë°›ì•˜ëŠ”ì§€ í™•ì¸
  6. ì£¼ë¬¸ ê¸ˆì•¡ >= `coupon.min_order_amount` í™•ì¸
  7. **ì„¸ì…˜ userId == user_coupons.user_id** í™•ì¸ (ë³´ì•ˆ)

#### 2.3.3 íŠ¸ëœì­ì…˜ ì²˜ë¦¬
```java
// ReservationService.java - ì˜ˆì•½ ìƒì„± ì‹œ ì¿ í° ì ìš© ì˜ˆì‹œ
public boolean createReservationWithCoupon(Reservation reservation, Long userCouponId) {
    SqlSession session = MyBatisSqlSessionFactory.getSqlSession();
    try {
        // 1. ì¿ í° ê²€ì¦ ë° í• ì¸ ê³„ì‚°
        if (userCouponId != null) {
            UserCoupon userCoupon = session.selectOne("UserCouponMapper.findById", userCouponId);
            Coupon coupon = session.selectOne("CouponMapper.findById", userCoupon.getCouponId());

            // ê²€ì¦
            if (!validateCoupon(userCoupon, coupon, reservation.getUserId(), reservation.getDepositAmount())) {
                throw new IllegalArgumentException("ì¿ í° ì‚¬ìš© ë¶ˆê°€");
            }

            // í• ì¸ ê³„ì‚°
            BigDecimal discount = calculateDiscount(coupon, reservation.getDepositAmount());
            reservation.setUserCouponId(userCouponId);
            reservation.setCouponDiscountAmount(discount);
            reservation.setDepositAmount(reservation.getDepositAmount().subtract(discount));
        }

        // 2. ì˜ˆì•½ ìƒì„±
        session.insert("ReservationMapper.insert", reservation);

        // 3. ì¿ í° ìƒíƒœ ë³€ê²½ (ê²°ì œ ì „ì—ëŠ” ë³€ê²½í•˜ì§€ ì•ŠìŒ - ê²°ì œ ì„±ê³µ ì‹œì—ë§Œ)
        // ì´ ì‹œì ì—ì„œëŠ” ì˜ˆì•½ë§Œ ìƒì„±í•˜ê³ , ê²°ì œ ì„±ê³µ ì‹œ NaverPayCallbackServletì—ì„œ ì²˜ë¦¬

        session.commit();
        return true;
    } catch (Exception e) {
        session.rollback();
        throw e;
    } finally {
        session.close();
    }
}

private boolean validateCoupon(UserCoupon userCoupon, Coupon coupon, int userId, BigDecimal orderAmount) {
    if (userCoupon.getUserId() != userId) return false; // ë³´ì•ˆ ì²´í¬
    if (userCoupon.isUsed()) return false;
    if (!coupon.isActive()) return false;
    if (coupon.getValidFrom() != null && LocalDateTime.now().isBefore(coupon.getValidFrom())) return false;
    if (coupon.getValidTo() != null && LocalDateTime.now().isAfter(coupon.getValidTo())) return false;
    if (coupon.getUsageCount() >= coupon.getUsageLimit()) return false;
    if (orderAmount.compareTo(coupon.getMinOrderAmount()) < 0) return false;
    return true;
}

private BigDecimal calculateDiscount(Coupon coupon, BigDecimal orderAmount) {
    BigDecimal discount = BigDecimal.ZERO;
    if ("FIXED".equals(coupon.getDiscountType())) {
        discount = coupon.getDiscountValue();
    } else if ("PERCENT".equals(coupon.getDiscountType())) {
        discount = orderAmount.multiply(coupon.getDiscountValue()).divide(new BigDecimal(100));
        if (coupon.getMaxDiscountAmount() != null) {
            discount = discount.min(coupon.getMaxDiscountAmount());
        }
    }
    return discount.setScale(2, RoundingMode.DOWN);
}
```

### 2.4 êµ¬í˜„ ë‹¨ê³„ (ìƒì„¸)

| ë‹¨ê³„ | ì‘ì—… ë‚´ìš© | ìˆ˜ì •/ì¶”ê°€ íŒŒì¼ | í•µì‹¬ ì½”ë“œ | ê²€ì¦ ë°©ë²• |
|------|-----------|----------------|-----------|-----------|
| **1** | **DB ìŠ¤í‚¤ë§ˆ ìˆ˜ì •** | `database/master.sql` | ìƒê¸° 2.3.1 SQL ì‹¤í–‰ | `DESCRIBE reservations;` í™•ì¸ |
| **2** | **UserCouponService ê²€ì¦ ë¡œì§ ì¶”ê°€** | `service/UserCouponService.java` | `validateCouponUsable(userCouponId, userId, orderAmount)` ë©”ì„œë“œ ì¶”ê°€ | JUnit ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ |
| **3** | **CouponMapperì— usage_count ì¦ê°€ ì¿¼ë¦¬ ì¶”ê°€** | `mappers/CouponMapper.xml` | `<update id="incrementUsageCount">UPDATE coupons SET usage_count = usage_count + 1 WHERE id = #{id} AND usage_count < usage_limit</update>` | MyBatis ë¡œê·¸ í™•ì¸ |
| **4** | **ì˜ˆì•½ ìƒì„± í™”ë©´ì— ì¿ í° ì„ íƒ UI ì¶”ê°€** | `WEB-INF/views/create-reservation.jsp` | 171ë¼ì¸ ì´í›„ì— `<select id="userCouponId" name="userCouponId"><option value="">ì¿ í° ì„ íƒ ì•ˆí•¨</option><c:forEach items="${availableCoupons}" var="c"><option value="${c.id}">${c.couponName} (${c.discountDisplay})</option></c:forEach></select>` ì¶”ê°€ | ë¸Œë¼ìš°ì €ì—ì„œ UI í™•ì¸ |
| **5** | **ReservationServletì—ì„œ ì¿ í° ì²˜ë¦¬** | `controller/ReservationServlet.java` | `handleReservationCreateSubmit` ë©”ì„œë“œì—ì„œ `userCouponId` íŒŒë¼ë¯¸í„° ë°›ì•„ì„œ `ReservationService.createReservationWithCoupon` í˜¸ì¶œ | ë””ë²„ê±°ë¡œ discount ê³„ì‚° í™•ì¸ |
| **6** | **ê²°ì œ ì„±ê³µ ì‹œ ì¿ í° ì‚¬ìš© ì²˜ë¦¬** | `controller/payment/NaverPayCallbackServlet.java` | `persistPayment` ë©”ì„œë“œ í›„ì— `if (reservation.getUserCouponId() != null) { userCouponService.markAsUsed(reservation.getUserCouponId()); couponService.incrementUsageCount(reservation.getCouponId()); }` ì¶”ê°€ | DBì—ì„œ `is_used=1`, `usage_count` ì¦ê°€ í™•ì¸ |
| **7** | **ê²°ì œ ì‹¤íŒ¨/ì·¨ì†Œ ì‹œ ë¡¤ë°± ì²˜ë¦¬** | `controller/payment/NaverPayCallbackServlet.java` | `handleFailure` ë©”ì„œë“œì—ì„œ ì¿ í° ìƒíƒœ ë¡¤ë°± (í•„ìš” ì‹œ `user_coupons.is_used=0`ìœ¼ë¡œ ë³µì›, ë‹¨ ê²°ì œ ì „ì—ëŠ” ë³€ê²½ ì•ˆ í–ˆìœ¼ë¯€ë¡œ ìƒëµ ê°€ëŠ¥) | ê²°ì œ ì‹¤íŒ¨ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ |
| **8** | **ê´€ë¦¬ì ì¿ í° ì§€ê¸‰ API (ì„ íƒ)** | `controller/admin/CouponIssueServlet.java` (ì‹ ê·œ) | `POST /admin/coupon/issue` - `UserCouponService.giveCouponToUser(userId, couponId)` í˜¸ì¶œ | Postmanìœ¼ë¡œ API í…ŒìŠ¤íŠ¸ |

### 2.5 í…ŒìŠ¤íŠ¸ / ê²€ì¦ (êµ¬ì²´í™”)

#### 2.5.1 ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (JUnit 5 + MyBatis Test)
```java
@ExtendWith(MockitoExtension.class)
class UserCouponServiceTest {
    @Mock private UserCouponMapper mapper;
    @InjectMocks private UserCouponService service;

    @Test
    void ì¿ í°_ê²€ì¦_ì„±ê³µ() {
        // Given
        UserCoupon uc = new UserCoupon(1L, 100L, 5L, false);
        Coupon c = new Coupon(5L, "10% í• ì¸", "PERCENT", new BigDecimal(10), true,
                              LocalDateTime.now().minusDays(1), LocalDateTime.now().plusDays(1),
                              new BigDecimal(5000), 100, 0);
        when(mapper.findById(1L)).thenReturn(uc);
        when(mapper.findCouponById(5L)).thenReturn(c);

        // When
        boolean result = service.validateCouponUsable(1L, 100L, new BigDecimal(10000));

        // Then
        assertTrue(result);
    }

    @Test
    void ì¿ í°_ê²€ì¦_ì‹¤íŒ¨_ë‹¤ë¥¸ì‚¬ìš©ì() {
        // Given
        UserCoupon uc = new UserCoupon(1L, 100L, 5L, false);
        when(mapper.findById(1L)).thenReturn(uc);

        // When/Then
        assertThrows(SecurityException.class, () ->
            service.validateCouponUsable(1L, 999L, new BigDecimal(10000))
        );
    }
}
```

#### 2.5.2 í†µí•© í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤
1. **ì‹œë‚˜ë¦¬ì˜¤ A: ì¿ í° ì‚¬ìš© ì„±ê³µ**
   ```
   1. ì‚¬ìš©ì ë¡œê·¸ì¸ (userId=10)
   2. /reservation/create í˜ì´ì§€ ì ‘ê·¼ â†’ ì‚¬ìš© ê°€ëŠ¥ ì¿ í° ëª©ë¡ ì¡°íšŒ
   3. ì˜ˆì•½ ìƒì„± (restaurantId=33, userCouponId=7, depositAmount=10000)
   4. í• ì¸ ê³„ì‚° (10% ì¿ í° â†’ 9000ì›ìœ¼ë¡œ ê°ì†Œ)
   5. ë„¤ì´ë²„í˜ì´ ê²°ì œ (9000ì›)
   6. ê²°ì œ ì„±ê³µ â†’ user_coupons.is_used=1, coupons.usage_count+1 í™•ì¸
   ```

2. **ì‹œë‚˜ë¦¬ì˜¤ B: ì¿ í° ê²€ì¦ ì‹¤íŒ¨**
   ```
   1. ë§Œë£Œëœ ì¿ í° ì„ íƒ â†’ ì„œë²„ ì—ëŸ¬ ë©”ì‹œì§€ "ì¿ í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤" í™•ì¸
   2. ìµœì†Œ ì£¼ë¬¸ ê¸ˆì•¡ ë¯¸ë‹¬ â†’ "ìµœì†Œ ì£¼ë¬¸ ê¸ˆì•¡ 5000ì› ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤" í™•ì¸
   3. ì´ë¯¸ ì‚¬ìš©í•œ ì¿ í° â†’ "ì´ë¯¸ ì‚¬ìš©ëœ ì¿ í°ì…ë‹ˆë‹¤" í™•ì¸
   ```

3. **ì‹œë‚˜ë¦¬ì˜¤ C: ê²°ì œ ì‹¤íŒ¨ ì‹œ ë¡¤ë°±**
   ```
   1. ì¿ í° ì„ íƒ í›„ ì˜ˆì•½ ìƒì„±
   2. ë„¤ì´ë²„í˜ì´ì—ì„œ ê²°ì œ ì‹¤íŒ¨ (ì¹´ë“œ í•œë„ ì´ˆê³¼ ë“±)
   3. user_coupons.is_used ìƒíƒœ ë³€ê²½ ì—†ìŒ í™•ì¸ (ê²°ì œ ì „ì—ëŠ” ë³€ê²½ ì•ˆ í•¨)
   4. ì¬ì‹œë„ ì‹œ ë™ì¼ ì¿ í° ì‚¬ìš© ê°€ëŠ¥ í™•ì¸
   ```

#### 2.5.3 íšŒê·€ í…ŒìŠ¤íŠ¸
- ê¸°ì¡´ ì¿ í° ê´€ë¦¬ í™”ë©´ (`/coupon-management`) ì •ìƒ ë™ì‘ í™•ì¸
- MyPage ì¿ í° íƒ­ì—ì„œ ì‚¬ìš© ì´ë ¥ í‘œì‹œ í™•ì¸
- ì¿ í° ì—†ëŠ” ì˜ˆì•½ ìƒì„± ì •ìƒ ì‘ë™ í™•ì¸

---

## 3. í¬ì¸íŠ¸ ì‹œìŠ¤í…œ ì‹ ê·œ êµ¬ì¶•

### 3.1 ìš”êµ¬ì‚¬í•­ ìš”ì•½
- ì‚¬ìš©ì í™œë™(ê²°ì œ, ë¦¬ë·° ë“±)ì— ë”°ë¼ ì ë¦½Â·ì°¨ê°ë˜ëŠ” í¬ì¸íŠ¸ ê³„ì¢Œ ë„ì…
- í¬ì¸íŠ¸ ì‚¬ìš© ì‹œ ì£¼ë¬¸ ê¸ˆì•¡ ì¼ë¶€ë¥¼ ëŒ€ì²´í•˜ê³ , ì‚¬ìš©/í™˜ë¶ˆ ì´ë ¥ ì¶”ì 
- ë§Œë£Œ ì •ì±…, ê´€ë¦¬ì ìˆ˜ë™ ì¡°ì •, ë§ˆì´í˜ì´ì§€ ì¡°íšŒ ê¸°ëŠ¥ í¬í•¨
- **ë™ì‹œì„± ì œì–´** ë° **ì •í•©ì„± ë³´ì¥** í•„ìˆ˜

### 3.2 ì•„í‚¤í…ì²˜ ì œì•ˆ

#### 3.2.1 DB ìŠ¤í‚¤ë§ˆ
```sql
-- ì‚¬ìš©ì í¬ì¸íŠ¸ ì”ì•¡ í…Œì´ë¸”
CREATE TABLE user_points (
  user_id INT PRIMARY KEY,
  balance INT NOT NULL DEFAULT 0 CHECK (balance >= 0),
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- í¬ì¸íŠ¸ ê±°ë˜ ë‚´ì—­ í…Œì´ë¸”
CREATE TABLE point_transactions (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  change_amount INT NOT NULL COMMENT 'ì–‘ìˆ˜: ì ë¦½, ìŒìˆ˜: ì°¨ê°',
  type ENUM('EARN', 'REDEEM', 'REFUND', 'EXPIRE', 'ADMIN') NOT NULL,
  reference_type ENUM('RESERVATION', 'REVIEW', 'PAYMENT', 'CANCEL', 'MANUAL') NULL,
  reference_id BIGINT NULL COMMENT 'ì°¸ì¡° ID (ì˜ˆì•½ ID, ë¦¬ë·° ID ë“±)',
  balance_after INT NOT NULL COMMENT 'ê±°ë˜ í›„ ì”ì•¡ (ê²€ì¦ìš©)',
  expires_at DATE NULL COMMENT 'ë§Œë£Œì¼ (ì ë¦½ ì‹œì—ë§Œ ì„¤ì •)',
  memo VARCHAR(500) NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  INDEX idx_user_created (user_id, created_at DESC),
  INDEX idx_expires (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- reservations í…Œì´ë¸”ì— í¬ì¸íŠ¸ ì‚¬ìš© ì»¬ëŸ¼ ì¶”ê°€
ALTER TABLE reservations
  ADD COLUMN points_used INT DEFAULT 0 AFTER coupon_discount_amount,
  ADD COLUMN points_earned INT DEFAULT 0 AFTER points_used;
```

#### 3.2.2 ë„ë©”ì¸/DAO/ì„œë¹„ìŠ¤
```java
// model/PointBalance.java
public class PointBalance {
    private int userId;
    private int balance;
    private LocalDateTime updatedAt;
    // getters/setters
}

// model/PointTransaction.java
public class PointTransaction {
    private Long id;
    private int userId;
    private int changeAmount;
    private String type; // EARN, REDEEM, REFUND, EXPIRE, ADMIN
    private String referenceType; // RESERVATION, REVIEW, PAYMENT, CANCEL, MANUAL
    private Long referenceId;
    private int balanceAfter;
    private LocalDate expiresAt;
    private String memo;
    private LocalDateTime createdAt;
    // getters/setters
}

// dao/PointDAO.java
public interface PointDAO {
    PointBalance getBalance(int userId);
    void initBalance(int userId); // ìµœì´ˆ 0ì›ìœ¼ë¡œ ì´ˆê¸°í™”
    int updateBalance(int userId, int changeAmount); // ì›ìì  ì—…ë°ì´íŠ¸, ë°˜í™˜ê°’: ì˜í–¥ë°›ì€ í–‰ ìˆ˜
    void insertTransaction(PointTransaction transaction);
    List<PointTransaction> findTransactions(int userId, String type, int offset, int limit);
    int sumExpiringPoints(int userId, LocalDate beforeDate); // ë§Œë£Œ ì˜ˆì • í¬ì¸íŠ¸ í•©ê³„
}

// service/PointService.java
@Service
public class PointService {
    private final PointDAO pointDAO;
    private static final int EXPIRE_DAYS = 365; // 1ë…„ í›„ ë§Œë£Œ

    // í¬ì¸íŠ¸ ì ë¦½
    public void awardPoints(int userId, int amount, String referenceType, Long referenceId) {
        SqlSession session = MyBatisSqlSessionFactory.getSqlSession();
        try {
            // 1. ì”ì•¡ ì´ˆê¸°í™” (ì—†ìœ¼ë©´)
            if (pointDAO.getBalance(userId) == null) {
                pointDAO.initBalance(userId);
            }

            // 2. ë™ì‹œì„± ì œì–´ë¥¼ ìœ„í•œ ì›ìì  ì—…ë°ì´íŠ¸
            int rows = session.update("PointMapper.updateBalance",
                Map.of("userId", userId, "changeAmount", amount));

            if (rows == 0) {
                throw new IllegalStateException("í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨");
            }

            // 3. ê±°ë˜ ë‚´ì—­ ê¸°ë¡
            PointBalance balance = pointDAO.getBalance(userId);
            PointTransaction tx = new PointTransaction();
            tx.setUserId(userId);
            tx.setChangeAmount(amount);
            tx.setType("EARN");
            tx.setReferenceType(referenceType);
            tx.setReferenceId(referenceId);
            tx.setBalanceAfter(balance.getBalance());
            tx.setExpiresAt(LocalDate.now().plusDays(EXPIRE_DAYS));
            tx.setMemo("ì ë¦½: " + referenceType);

            pointDAO.insertTransaction(tx);
            session.commit();
        } catch (Exception e) {
            session.rollback();
            throw e;
        } finally {
            session.close();
        }
    }

    // í¬ì¸íŠ¸ ì°¨ê°
    public void redeemPoints(int userId, int amount, String referenceType, Long referenceId) {
        SqlSession session = MyBatisSqlSessionFactory.getSqlSession();
        try {
            PointBalance balance = pointDAO.getBalance(userId);
            if (balance == null || balance.getBalance() < amount) {
                throw new IllegalArgumentException("í¬ì¸íŠ¸ ì”ì•¡ ë¶€ì¡±");
            }

            // ì›ìì  ì°¨ê° (ì”ì•¡ ë¶€ì¡± ì‹œ ì‹¤íŒ¨)
            int rows = session.update("PointMapper.redeemBalance",
                Map.of("userId", userId, "changeAmount", amount, "minBalance", amount));

            if (rows == 0) {
                throw new IllegalStateException("í¬ì¸íŠ¸ ì”ì•¡ ë¶€ì¡± ë˜ëŠ” ë™ì‹œì„± ì¶©ëŒ");
            }

            // ê±°ë˜ ë‚´ì—­ ê¸°ë¡
            PointBalance newBalance = pointDAO.getBalance(userId);
            PointTransaction tx = new PointTransaction();
            tx.setUserId(userId);
            tx.setChangeAmount(-amount);
            tx.setType("REDEEM");
            tx.setReferenceType(referenceType);
            tx.setReferenceId(referenceId);
            tx.setBalanceAfter(newBalance.getBalance());
            tx.setMemo("ì‚¬ìš©: " + referenceType);

            pointDAO.insertTransaction(tx);
            session.commit();
        } catch (Exception e) {
            session.rollback();
            throw e;
        } finally {
            session.close();
        }
    }

    // í™˜ë¶ˆ
    public void refundPoints(int userId, int amount, String referenceType, Long referenceId) {
        awardPoints(userId, amount, referenceType, referenceId); // ë™ì¼ ë¡œì§ ì¬ì‚¬ìš©
        // typeë§Œ REFUNDë¡œ ë³€ê²½ í•„ìš” ì‹œ ë³„ë„ êµ¬í˜„
    }

    // ì”ì•¡ ì¡°íšŒ
    public int getBalance(int userId) {
        PointBalance balance = pointDAO.getBalance(userId);
        return balance != null ? balance.getBalance() : 0;
    }

    // ê±°ë˜ ë‚´ì—­ ì¡°íšŒ
    public List<PointTransaction> listTransactions(int userId, String type, int page, int pageSize) {
        return pointDAO.findTransactions(userId, type, (page - 1) * pageSize, pageSize);
    }

    // ë§Œë£Œ ì²˜ë¦¬ (ë°°ì¹˜ ì‘ì—…)
    public void expirePoints() {
        // Quartz Job ë˜ëŠ” ìŠ¤ì¼€ì¤„ëŸ¬ì—ì„œ í˜¸ì¶œ
        // ë§Œë£Œì¼ì´ ì§€ë‚œ EARN ê±°ë˜ë¥¼ ì°¾ì•„ì„œ ì°¨ê°
    }
}
```

#### 3.2.3 MyBatis ë§¤í¼
```xml
<!-- mappers/PointMapper.xml -->
<mapper namespace="mapper.PointMapper">
  <resultMap id="PointBalanceMap" type="model.PointBalance">
    <id property="userId" column="user_id"/>
    <result property="balance" column="balance"/>
    <result property="updatedAt" column="updated_at"/>
  </resultMap>

  <resultMap id="PointTransactionMap" type="model.PointTransaction">
    <id property="id" column="id"/>
    <result property="userId" column="user_id"/>
    <result property="changeAmount" column="change_amount"/>
    <result property="type" column="type"/>
    <result property="referenceType" column="reference_type"/>
    <result property="referenceId" column="reference_id"/>
    <result property="balanceAfter" column="balance_after"/>
    <result property="expiresAt" column="expires_at"/>
    <result property="memo" column="memo"/>
    <result property="createdAt" column="created_at"/>
  </resultMap>

  <select id="getBalance" resultMap="PointBalanceMap">
    SELECT * FROM user_points WHERE user_id = #{userId} FOR UPDATE
  </select>

  <insert id="initBalance">
    INSERT INTO user_points (user_id, balance) VALUES (#{userId}, 0)
    ON DUPLICATE KEY UPDATE balance = balance
  </insert>

  <update id="updateBalance">
    UPDATE user_points
    SET balance = balance + #{changeAmount}, updated_at = NOW()
    WHERE user_id = #{userId}
  </update>

  <update id="redeemBalance">
    UPDATE user_points
    SET balance = balance - #{changeAmount}, updated_at = NOW()
    WHERE user_id = #{userId} AND balance >= #{minBalance}
  </update>

  <insert id="insertTransaction">
    INSERT INTO point_transactions
      (user_id, change_amount, type, reference_type, reference_id, balance_after, expires_at, memo)
    VALUES
      (#{userId}, #{changeAmount}, #{type}, #{referenceType}, #{referenceId}, #{balanceAfter}, #{expiresAt}, #{memo})
  </insert>

  <select id="findTransactions" resultMap="PointTransactionMap">
    SELECT * FROM point_transactions
    WHERE user_id = #{userId}
    <if test="type != null">AND type = #{type}</if>
    ORDER BY created_at DESC
    LIMIT #{offset}, #{limit}
  </select>

  <select id="sumExpiringPoints" resultType="int">
    SELECT COALESCE(SUM(change_amount), 0)
    FROM point_transactions
    WHERE user_id = #{userId}
      AND type = 'EARN'
      AND expires_at &lt;= #{beforeDate}
      AND expires_at IS NOT NULL
  </select>
</mapper>
```

### 3.3 ì—…ë¬´ í”Œë¡œìš° ì—°ê³„ (ìƒì„¸)

#### 3.3.1 ì˜ˆì•½ ê²°ì œ ì„±ê³µ ì‹œ í¬ì¸íŠ¸ ì ë¦½
```java
// NaverPayCallbackServlet.java - confirmResult.isSuccess() ë¸”ë¡ ë‚´
if (confirmResult.isSuccess()) {
    naverPayService.markPaymentSuccess(reservation, merchantPayKey);
    persistPayment(reservation);

    // ì¿ í° ì‚¬ìš© ì²˜ë¦¬
    if (reservation.getUserCouponId() != null) {
        userCouponService.markAsUsed(reservation.getUserCouponId());
        couponService.incrementUsageCount(...);
    }

    // í¬ì¸íŠ¸ ì ë¦½ (ê²°ì œ ê¸ˆì•¡ì˜ 5%)
    BigDecimal earnRate = new BigDecimal("0.05");
    int earnedPoints = reservation.getDepositAmount()
        .multiply(earnRate)
        .intValue();
    pointService.awardPoints(
        reservation.getUserId(),
        earnedPoints,
        "PAYMENT",
        (long) reservation.getId()
    );

    // ì˜ˆì•½ì— ì ë¦½ í¬ì¸íŠ¸ ê¸°ë¡
    reservation.setPointsEarned(earnedPoints);
    reservationService.updateReservationStatus(reservation.getId(), reservation.getStatus());

    redirectSuccess(request, response);
}
```

#### 3.3.2 ì˜ˆì•½ ìƒì„± ì‹œ í¬ì¸íŠ¸ ì‚¬ìš©
```java
// ReservationServlet.handleReservationCreateSubmit - ì¿ í° ì²˜ë¦¬ í›„
String pointsUsedParam = request.getParameter("pointsUsed");
int pointsUsed = 0;
if (pointsUsedParam != null && !pointsUsedParam.isEmpty()) {
    pointsUsed = Integer.parseInt(pointsUsedParam);

    // í¬ì¸íŠ¸ ê²€ì¦
    int userBalance = pointService.getBalance(user.getId());
    if (pointsUsed > userBalance) {
        throw new Exception("í¬ì¸íŠ¸ ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
    }
    if (pointsUsed > reservation.getDepositAmount().intValue()) {
        throw new Exception("í¬ì¸íŠ¸ëŠ” ê²°ì œ ê¸ˆì•¡ì„ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }

    // í¬ì¸íŠ¸ ì°¨ê° (ê²°ì œ ì„±ê³µ ì‹œì—ë§Œ ì‹¤ì œ ì°¨ê°)
    reservation.setPointsUsed(pointsUsed);
    reservation.setDepositAmount(
        reservation.getDepositAmount().subtract(new BigDecimal(pointsUsed))
    );
}

// ... ì˜ˆì•½ ìƒì„± í›„ ê²°ì œ í˜ì´ì§€ë¡œ ì´ë™
```

#### 3.3.3 ê²°ì œ ì‹¤íŒ¨ ì‹œ í¬ì¸íŠ¸ ë¡¤ë°±
```java
// NaverPayCallbackServlet.handleFailure
private void handleFailure(Reservation reservation, String merchantPayKey,
                          HttpServletRequest request, HttpServletResponse response,
                          String message) throws IOException {
    naverPayService.markPaymentFailure(reservation, merchantPayKey);
    persistPayment(reservation);

    // í¬ì¸íŠ¸ ì‚¬ìš©í–ˆë‹¤ë©´ ë¡¤ë°± (í™˜ë¶ˆ)
    if (reservation.getPointsUsed() > 0) {
        pointService.refundPoints(
            reservation.getUserId(),
            reservation.getPointsUsed(),
            "CANCEL",
            (long) reservation.getId()
        );
    }

    redirectFailure(request, response, message);
}
```

#### 3.3.4 ë¦¬ë·° ì‘ì„± ì‹œ í¬ì¸íŠ¸ ì ë¦½
```java
// ReviewService.addReview - ë¦¬ë·° ë“±ë¡ ì„±ê³µ í›„
public boolean addReview(Review review) {
    SqlSession session = MyBatisSqlSessionFactory.getSqlSession();
    try {
        session.insert("ReviewMapper.insertReview", review);

        // ë¦¬ë·° ì‘ì„± í¬ì¸íŠ¸ ì ë¦½ (500ì )
        pointService.awardPoints(
            review.getUserId(),
            500,
            "REVIEW",
            review.getId()
        );

        session.commit();
        return true;
    } catch (Exception e) {
        session.rollback();
        throw e;
    } finally {
        session.close();
    }
}
```

### 3.4 UI/ê´€ë¦¬ (ìƒì„¸)

#### 3.4.1 ì˜ˆì•½ ìƒì„± í™”ë©´ì— í¬ì¸íŠ¸ ì‚¬ìš© UI ì¶”ê°€
```jsp
<!-- create-reservation.jsp - ì¿ í° ì„ íƒ UI ë‹¤ìŒì— ì¶”ê°€ -->
<div class="mb-4">
    <label for="pointsUsed" class="block text-sm font-medium text-slate-700 mb-2">
        í¬ì¸íŠ¸ ì‚¬ìš© (ë³´ìœ : <span id="userPoints">${userPoints}</span>P)
    </label>
    <div class="flex gap-2">
        <input type="number" id="pointsUsed" name="pointsUsed"
               min="0" max="${userPoints}" value="0"
               class="form-input flex-1" placeholder="ì‚¬ìš©í•  í¬ì¸íŠ¸ ì…ë ¥">
        <button type="button" onclick="useAllPoints()"
                class="px-4 py-2 bg-blue-500 text-white rounded">
            ì „ì•¡ ì‚¬ìš©
        </button>
    </div>
    <p class="text-xs text-slate-500 mt-1">
        ìµœì¢… ê²°ì œ ê¸ˆì•¡: <span id="finalAmount">${reservation.depositAmount}</span>ì›
    </p>
</div>

<script>
function useAllPoints() {
    const userPoints = parseInt(document.getElementById('userPoints').textContent);
    const depositAmount = ${reservation.depositAmount};
    const maxUsable = Math.min(userPoints, depositAmount);
    document.getElementById('pointsUsed').value = maxUsable;
    updateFinalAmount();
}

function updateFinalAmount() {
    const deposit = ${reservation.depositAmount};
    const couponDiscount = ${reservation.couponDiscountAmount || 0};
    const pointsUsed = parseInt(document.getElementById('pointsUsed').value) || 0;
    const finalAmount = Math.max(0, deposit - couponDiscount - pointsUsed);
    document.getElementById('finalAmount').textContent = finalAmount.toLocaleString();
}

document.getElementById('pointsUsed').addEventListener('input', updateFinalAmount);
</script>
```

#### 3.4.2 ë§ˆì´í˜ì´ì§€ í¬ì¸íŠ¸ ë‚´ì—­
```jsp
<!-- mypage/points.jsp (ì‹ ê·œ) -->
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>

<div class="max-w-4xl mx-auto p-6">
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
        <h2 class="text-2xl font-bold mb-4">ë‚´ í¬ì¸íŠ¸</h2>
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-slate-600">ë³´ìœ  í¬ì¸íŠ¸</p>
                <p class="text-4xl font-bold text-blue-600">${pointBalance.balance}<span class="text-2xl">P</span></p>
            </div>
            <div class="text-right">
                <p class="text-sm text-slate-600">ë§Œë£Œ ì˜ˆì • (30ì¼ ë‚´)</p>
                <p class="text-xl font-semibold text-red-600">${expiringPoints}P</p>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-xl font-semibold mb-4">í¬ì¸íŠ¸ ë‚´ì—­</h3>
        <table class="w-full">
            <thead>
                <tr class="border-b">
                    <th class="text-left py-2">ë‚ ì§œ</th>
                    <th class="text-left py-2">êµ¬ë¶„</th>
                    <th class="text-right py-2">í¬ì¸íŠ¸</th>
                    <th class="text-right py-2">ì”ì•¡</th>
                </tr>
            </thead>
            <tbody>
                <c:forEach items="${transactions}" var="tx">
                    <tr class="border-b">
                        <td class="py-3">
                            <fmt:formatDate value="${tx.createdAt}" pattern="yyyy-MM-dd HH:mm"/>
                        </td>
                        <td class="py-3">
                            <span class="px-2 py-1 rounded text-xs ${tx.type == 'EARN' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                ${tx.type}
                            </span>
                            <span class="text-sm text-slate-600 ml-2">${tx.memo}</span>
                        </td>
                        <td class="py-3 text-right ${tx.changeAmount > 0 ? 'text-green-600' : 'text-red-600'}">
                            ${tx.changeAmount > 0 ? '+' : ''}${tx.changeAmount}
                        </td>
                        <td class="py-3 text-right">${tx.balanceAfter}</td>
                    </tr>
                </c:forEach>
            </tbody>
        </table>
    </div>
</div>
```

#### 3.4.3 ê´€ë¦¬ì í¬ì¸íŠ¸ ê´€ë¦¬ í™”ë©´ (ì„ íƒ)
```jsp
<!-- admin/point-management.jsp -->
<form method="POST" action="${pageContext.request.contextPath}/admin/points/adjust">
    <select name="userId" required>
        <option value="">ì‚¬ìš©ì ì„ íƒ</option>
        <c:forEach items="${users}" var="u">
            <option value="${u.id}">${u.nickname} (${u.email})</option>
        </c:forEach>
    </select>
    <input type="number" name="amount" placeholder="í¬ì¸íŠ¸ (ì–‘ìˆ˜=ì§€ê¸‰, ìŒìˆ˜=ì°¨ê°)" required>
    <input type="text" name="memo" placeholder="ì‚¬ìœ " required>
    <button type="submit">ì ìš©</button>
</form>
```

### 3.5 ë™ì‹œì„±/ì •í•©ì„± (ì‹¬í™”)

#### 3.5.1 ë™ì‹œ ìš”ì²­ ê²½ìŸ ì œì–´
```xml
<!-- PointMapper.xml - ì›ìì  ì—…ë°ì´íŠ¸ -->
<update id="redeemBalance">
  UPDATE user_points
  SET balance = balance - #{changeAmount}, updated_at = NOW()
  WHERE user_id = #{userId}
    AND balance >= #{changeAmount}  <!-- ì”ì•¡ ë¶€ì¡± ì‹œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ -->
</update>
```
- **ì‘ë™ ì›ë¦¬**: MySQLì˜ `UPDATE ... WHERE` ì¡°ê±´ì´ ë§Œì¡±í•˜ì§€ ì•Šìœ¼ë©´ `affected rows = 0` ë°˜í™˜ â†’ Javaì—ì„œ ê°ì§€í•˜ì—¬ ì˜ˆì™¸ ë°œìƒ

#### 3.5.2 íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€
```java
// MyBatisSqlSessionFactory.java - íŠ¸ëœì­ì…˜ ì„¤ì •
public static SqlSession getSqlSessionWithIsolation(TransactionIsolationLevel level) {
    return sqlSessionFactory.openSession(level);
}

// PointServiceì—ì„œ ì‚¬ìš©
SqlSession session = MyBatisSqlSessionFactory.getSqlSessionWithIsolation(
    TransactionIsolationLevel.READ_COMMITTED
);
```

#### 3.5.3 Optimistic Locking (ì„ íƒì  êµ¬í˜„)
```sql
-- user_pointsì— version ì»¬ëŸ¼ ì¶”ê°€ (ë‚™ê´€ì  ì ê¸ˆ)
ALTER TABLE user_points ADD COLUMN version INT DEFAULT 0;

-- ì—…ë°ì´íŠ¸ ì‹œ version ì²´í¬
UPDATE user_points
SET balance = balance + #{changeAmount},
    version = version + 1,
    updated_at = NOW()
WHERE user_id = #{userId} AND version = #{expectedVersion}
```

### 3.6 êµ¬í˜„ ë‹¨ê³„ (ìƒì„¸)

| ë‹¨ê³„ | ì‘ì—… ë‚´ìš© | ìˆ˜ì •/ì¶”ê°€ íŒŒì¼ | í•µì‹¬ ì½”ë“œ | ê²€ì¦ ë°©ë²• |
|------|-----------|----------------|-----------|-----------|
| **A** | **DB í…Œì´ë¸” ì¶”ê°€** | `database/master.sql` | ìƒê¸° 3.2.1 SQL ì‹¤í–‰ | `SHOW TABLES LIKE 'user_points%';` |
| **B** | **ëª¨ë¸ í´ë˜ìŠ¤ ìƒì„±** | `model/PointBalance.java`, `model/PointTransaction.java` | POJO ì •ì˜ | ì»´íŒŒì¼ í™•ì¸ |
| **C** | **DAO/Mapper êµ¬í˜„** | `dao/PointDAO.java`, `mappers/PointMapper.xml` | ìƒê¸° 3.2.3 ì½”ë“œ | MyBatis ë¡œê·¸ `DEBUG` ë ˆë²¨ë¡œ ì¿¼ë¦¬ í™•ì¸ |
| **D** | **PointService êµ¬í˜„** | `service/PointService.java` | ìƒê¸° 3.2.2 ì½”ë“œ | JUnit ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (ë™ì‹œì„± í…ŒìŠ¤íŠ¸ í¬í•¨) |
| **E** | **ê²°ì œ ì„±ê³µ ì‹œ ì ë¦½** | `controller/payment/NaverPayCallbackServlet.java` | ìƒê¸° 3.3.1 ì½”ë“œ | ê²°ì œ í›„ `point_transactions` í…Œì´ë¸” í™•ì¸ |
| **F** | **ì˜ˆì•½ ìƒì„± ì‹œ í¬ì¸íŠ¸ ì‚¬ìš© UI** | `WEB-INF/views/create-reservation.jsp` | ìƒê¸° 3.4.1 ì½”ë“œ | ë¸Œë¼ìš°ì €ì—ì„œ UI ë™ì‘ í™•ì¸ |
| **G** | **í¬ì¸íŠ¸ ì‚¬ìš© ë¡œì§** | `controller/ReservationServlet.java` | ìƒê¸° 3.3.2 ì½”ë“œ | ë””ë²„ê±°ë¡œ `pointsUsed` ê°’ ì¶”ì  |
| **H** | **ê²°ì œ ì‹¤íŒ¨ ì‹œ ë¡¤ë°±** | `controller/payment/NaverPayCallbackServlet.java` | ìƒê¸° 3.3.3 ì½”ë“œ | ê²°ì œ ì‹¤íŒ¨ â†’ í¬ì¸íŠ¸ í™˜ë¶ˆ í™•ì¸ |
| **I** | **ë¦¬ë·° ì‘ì„± ì ë¦½** | `service/ReviewService.java` | ìƒê¸° 3.3.4 ì½”ë“œ | ë¦¬ë·° ì‘ì„± í›„ 500P ì ë¦½ í™•ì¸ |
| **J** | **ë§ˆì´í˜ì´ì§€ UI** | `WEB-INF/views/mypage/points.jsp` (ì‹ ê·œ), `controller/MypageServlet.java` | ìƒê¸° 3.4.2 ì½”ë“œ | `/mypage/points` ì ‘ê·¼ í…ŒìŠ¤íŠ¸ |
| **K** | **ë§Œë£Œ ë°°ì¹˜ (ì„ íƒ)** | `batch/PointExpirationJob.java` (Quartz) | Quartz Scheduler ì„¤ì • | ìŠ¤ì¼€ì¤„ëŸ¬ ë¡œê·¸ í™•ì¸ |

### 3.7 í…ŒìŠ¤íŠ¸ / ê²€ì¦ (êµ¬ì²´í™”)

#### 3.7.1 ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (ë™ì‹œì„± í¬í•¨)
```java
@Test
void í¬ì¸íŠ¸_ë™ì‹œ_ì°¨ê°_í…ŒìŠ¤íŠ¸() throws InterruptedException {
    // Given
    int userId = 100;
    pointService.awardPoints(userId, 1000, "MANUAL", null);

    ExecutorService executor = Executors.newFixedThreadPool(10);
    CountDownLatch latch = new CountDownLatch(10);
    AtomicInteger successCount = new AtomicInteger(0);

    // When - 10ê°œ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— 200Pì”© ì°¨ê° ì‹œë„ (ì´ 2000P, ì”ì•¡ì€ 1000P)
    for (int i = 0; i < 10; i++) {
        executor.submit(() -> {
            try {
                pointService.redeemPoints(userId, 200, "TEST", null);
                successCount.incrementAndGet();
            } catch (IllegalStateException e) {
                // ì”ì•¡ ë¶€ì¡±ìœ¼ë¡œ ì‹¤íŒ¨ (ì˜ˆìƒëœ ë™ì‘)
            } finally {
                latch.countDown();
            }
        });
    }
    latch.await();

    // Then - 5ê°œë§Œ ì„±ê³µí•´ì•¼ í•¨ (1000P / 200P = 5)
    assertEquals(5, successCount.get());
    assertEquals(0, pointService.getBalance(userId)); // ì”ì•¡ 0
}
```

#### 3.7.2 í†µí•© í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤
1. **ì‹œë‚˜ë¦¬ì˜¤ A: í¬ì¸íŠ¸ ì ë¦½ ë° ì‚¬ìš©**
   ```
   1. ë¦¬ë·° ì‘ì„± â†’ 500P ì ë¦½ í™•ì¸
   2. ì˜ˆì•½ ìƒì„± ì‹œ 300P ì‚¬ìš© â†’ ì”ì•¡ 200P í™•ì¸
   3. ê²°ì œ ì„±ê³µ â†’ ê²°ì œ ê¸ˆì•¡ì˜ 5% ì¶”ê°€ ì ë¦½
   4. ë§ˆì´í˜ì´ì§€ì—ì„œ ê±°ë˜ ë‚´ì—­ í™•ì¸
   ```

2. **ì‹œë‚˜ë¦¬ì˜¤ B: ì”ì•¡ ë¶€ì¡± ì‹œ ì—ëŸ¬ ì²˜ë¦¬**
   ```
   1. ë³´ìœ  í¬ì¸íŠ¸ 100P
   2. ì˜ˆì•½ ì‹œ 200P ì‚¬ìš© ì‹œë„ â†’ "í¬ì¸íŠ¸ ì”ì•¡ ë¶€ì¡±" ì—ëŸ¬ ë©”ì‹œì§€ í™•ì¸
   ```

3. **ì‹œë‚˜ë¦¬ì˜¤ C: ê²°ì œ ì‹¤íŒ¨ ì‹œ í¬ì¸íŠ¸ í™˜ë¶ˆ**
   ```
   1. 300P ì‚¬ìš©í•˜ì—¬ ì˜ˆì•½ ìƒì„± (ì”ì•¡ 500P â†’ 200P)
   2. ê²°ì œ ì‹¤íŒ¨ â†’ í¬ì¸íŠ¸ 300P í™˜ë¶ˆ (ì”ì•¡ 200P â†’ 500P)
   3. ê±°ë˜ ë‚´ì—­ì— REFUND íƒ€ì…ìœ¼ë¡œ ê¸°ë¡ í™•ì¸
   ```

#### 3.7.3 íšŒê·€ í…ŒìŠ¤íŠ¸
- í¬ì¸íŠ¸ ì—†ëŠ” ì˜ˆì•½ ìƒì„± ì •ìƒ ì‘ë™ í™•ì¸
- ê¸°ì¡´ ê²°ì œ í”Œë¡œìš° ì˜í–¥ ì—†ìŒ í™•ì¸
- ë¦¬ë·° ì‹œìŠ¤í…œ ì •ìƒ ì‘ë™ í™•ì¸

---

## 4. í…”ë ˆê·¸ë¨ ì•Œë¦¼ ì—°ë™ ê³„íš (Tomcat 9 Â· Java 11 Â· Maven Â· MyBatis)

### 4.1 ì „ì œ Â· í™˜ê²½
- **ëª©í‘œ**: íšŒì›ë³„ í…”ë ˆê·¸ë¨ DM ì•Œë¦¼ ë°œì†¡
  âœ ì „í™”ë²ˆí˜¸ë§Œìœ¼ë¡œ ë°œì†¡ ë¶ˆê°€í•˜ë¯€ë¡œ ì‚¬ìš©ì `/start` ì˜¨ë³´ë”©ì´ ë°˜ë“œì‹œ ì„ í–‰ë˜ì–´ì•¼ í•¨
- **ëŸ°íƒ€ì„**: JDK 11, Tomcat 9 (Servlet 4.0 `javax.*`), Maven, MyBatis
- **í”„ë¡œì íŠ¸ êµ¬ì¡°**
  ```
  MEETLOG/MeetLog/
    â””â”€ src/
       â”œâ”€ main/java/            # Java
       â”œâ”€ main/resources/       # âœ” api.properties
       â””â”€ main/webapp/          # JSP/ì •ì 
  ```
- **ì„¤ì • íŒŒì¼** (`src/main/resources/api.properties`)
  ```properties
  telegram.bot.token=123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11
  telegram.bot.name=meetlog_bot
  telegram.baseUrl=https://api.telegram.org
  telegram.poll.timeout=50
  ```
- **Maven ì˜ì¡´ì„±** (Jackson í•„ìˆ˜)
  ```xml
  <dependency>
    <groupId>javax.servlet</groupId>
    <artifactId>javax.servlet-api</artifactId>
    <version>4.0.1</version>
    <scope>provided</scope>
  </dependency>
  <dependency>
    <groupId>com.fasterxml.jackson.core</groupId>
    <artifactId>jackson-databind</artifactId>
    <version>2.17.1</version>
  </dependency>
  ```

### 4.2 ë°ì´í„° ëª¨ë¸
```sql
-- tg_link í…Œì´ë¸” ì •ì˜
CREATE TABLE tg_link (
  id           BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id      INT NOT NULL COMMENT 'íšŒì› ID (users.id)',
  tg_user_id   BIGINT NULL COMMENT 'í…”ë ˆê·¸ë¨ ì‚¬ìš©ì ID',
  chat_id      VARCHAR(32) NULL COMMENT 'ì±„íŒ…ë°© ID (DMìš©)',
  start_token  VARCHAR(64) NOT NULL UNIQUE COMMENT 'ì˜¨ë³´ë”© í† í°',
  state        ENUM('PENDING','ACTIVE','BLOCKED') NOT NULL DEFAULT 'PENDING',
  created_at   TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at   TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY ux_tg_user (user_id),
  KEY ix_tg_state (state),
  KEY ix_start_token (start_token),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**ìƒíƒœ ì „ì´**
- `PENDING` (í† í° ë°œê¸‰) â†’ `/start TOKEN` ìˆ˜ì‹  ì‹œ `ACTIVE`ë¡œ ì „í™˜í•˜ë©° `chat_id/tg_user_id` ì €ì¥
- ë°œì†¡ ì‹œ 403(ì°¨ë‹¨) ë°œìƒ â†’ `BLOCKED`ë¡œ ì „í™˜í•˜ì—¬ ì¬ì˜¨ë³´ë”© í•„ìš”

### 4.3 ì˜¨ë³´ë”© í”Œë¡œìš° (/start ë”¥ë§í¬)

#### 4.3.1 ì‚¬ìš©ì í”Œë¡œìš°
1. ë§ˆì´í˜ì´ì§€ì—ì„œ **í…”ë ˆê·¸ë¨ ì—°ê²°** ë²„íŠ¼ í´ë¦­
2. ì„œë²„ê°€ í† í° ë°œê¸‰ í›„ `tg_link`ì— `PENDING` ìƒíƒœë¡œ upsert
3. ì‚¬ìš©ìì—ê²Œ `https://t.me/<bot>?start=TOKEN` ë”¥ë§í¬ ì „ë‹¬ (QR ì½”ë“œ ë˜ëŠ” ë²„íŠ¼)
4. ì‚¬ìš©ìê°€ Start â†’ ë´‡ì´ `/start TOKEN` ìˆ˜ì‹ 
5. í´ëŸ¬ê°€ í† í°ì„ ì†Œë¹„í•´ `ACTIVE`ë¡œ ì „í™˜í•˜ê³  í™˜ì˜ ë©”ì‹œì§€ ë°œì†¡

#### 4.3.2 í† í° ë°œê¸‰ ì„œë¸”ë¦¿
```java
package controller.telegram;

import javax.servlet.annotation.WebServlet;
import javax.servlet.http.*;
import java.io.IOException;
import org.apache.ibatis.session.SqlSession;
import util.MyBatisSqlSessionFactory;

@WebServlet("/member/telegram/link")
public class TelegramLinkServlet extends HttpServlet {
    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws IOException {
        HttpSession session = req.getSession(false);
        if (session == null || session.getAttribute("user") == null) {
            resp.setStatus(401);
            resp.getWriter().write("{\"error\":\"ë¡œê·¸ì¸ í•„ìš”\"}");
            return;
        }

        int userId = ((model.User) session.getAttribute("user")).getId();
        String token = java.util.UUID.randomUUID().toString().replace("-", "");

        SqlSession sqlSession = MyBatisSqlSessionFactory.getSqlSession();
        try {
            sqlSession.insert("TgLinkMapper.upsertPending",
                java.util.Map.of("userId", userId, "token", token));
            sqlSession.commit();
        } finally {
            sqlSession.close();
        }

        String botName = util.AppConfig.getProperty("telegram.bot.name", "meetlog_bot");
        String deepLink = "https://t.me/" + botName + "?start=" + token;

        resp.setContentType("application/json;charset=UTF-8");
        resp.getWriter().write("{\"deepLink\":\""+deepLink+"\"}");
    }
}
```

#### 4.3.3 JSP UI (ë§ˆì´í˜ì´ì§€)
```jsp
<!-- mypage.jsp - ì•Œë¦¼ ì„¤ì • íƒ­ -->
<div class="bg-white rounded-xl shadow-lg p-6">
    <h3 class="text-xl font-semibold mb-4">í…”ë ˆê·¸ë¨ ì•Œë¦¼ ì„¤ì •</h3>
    <div id="tg-status">
        <c:choose>
            <c:when test="${tgLink != null && tgLink.state == 'ACTIVE'}">
                <p class="text-green-600">âœ… ì—°ê²°ë¨ (chat_id: ${tgLink.chatId})</p>
                <button onclick="unlinkTelegram()" class="mt-2 px-4 py-2 bg-red-500 text-white rounded">
                    ì—°ê²° í•´ì œ
                </button>
            </c:when>
            <c:when test="${tgLink != null && tgLink.state == 'BLOCKED'}">
                <p class="text-red-600">âŒ ì°¨ë‹¨ë¨ (ì¬ì—°ê²° í•„ìš”)</p>
                <button onclick="linkTelegram()" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded">
                    ì¬ì—°ê²°
                </button>
            </c:when>
            <c:otherwise>
                <p class="text-slate-600">í…”ë ˆê·¸ë¨ ì•Œë¦¼ì„ ë°›ìœ¼ë ¤ë©´ ë´‡ì„ ì—°ê²°í•˜ì„¸ìš”</p>
                <button onclick="linkTelegram()" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded">
                    í…”ë ˆê·¸ë¨ ì—°ê²°
                </button>
            </c:otherwise>
        </c:choose>
    </div>
    <div id="tg-deeplink" class="mt-4 hidden">
        <p class="text-sm text-slate-600">ì•„ë˜ ë§í¬ë¥¼ í´ë¦­í•˜ì—¬ ë´‡ì„ ì‹œì‘í•˜ì„¸ìš”:</p>
        <a id="deeplink-url" href="#" target="_blank"
           class="text-blue-600 underline break-all"></a>
    </div>
</div>

<script>
function linkTelegram() {
    fetch('${pageContext.request.contextPath}/member/telegram/link', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(res => res.json())
    .then(data => {
        if (data.deepLink) {
            document.getElementById('deeplink-url').href = data.deepLink;
            document.getElementById('deeplink-url').textContent = data.deepLink;
            document.getElementById('tg-deeplink').classList.remove('hidden');
            alert('í…”ë ˆê·¸ë¨ ë´‡ì„ ì‹œì‘í•´ì£¼ì„¸ìš”!');
        }
    });
}

function unlinkTelegram() {
    if (confirm('í…”ë ˆê·¸ë¨ ì—°ê²°ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        fetch('${pageContext.request.contextPath}/member/telegram/unlink', {method: 'POST'})
        .then(() => location.reload());
    }
}
</script>
```

### 4.4 í´ë§ ì•„í‚¤í…ì²˜ (ì˜¨ë³´ë”© ì „ìš©)

#### 4.4.1 í´ëŸ¬ ë¦¬ìŠ¤ë„ˆ (ServletContextListener)
```java
package telegram;

import javax.servlet.*;
import javax.servlet.annotation.WebListener;
import java.io.*;
import java.net.URI;
import java.net.http.*;
import java.time.Duration;
import java.util.Properties;
import java.util.concurrent.*;
import com.fasterxml.jackson.databind.*;
import org.apache.ibatis.session.SqlSession;
import util.MyBatisSqlSessionFactory;

@WebListener
public class OnboardingPoller implements ServletContextListener {
    private ExecutorService loop;
    private volatile boolean running;
    private final ObjectMapper om = new ObjectMapper();
    private String token, baseUrl;
    private int pollTimeout;

    @Override
    public void contextInitialized(ServletContextEvent sce) {
        Properties p = loadProps("api.properties");
        token = envOr(p, "telegram.bot.token", "TG_TOKEN");
        baseUrl = p.getProperty("telegram.baseUrl", "https://api.telegram.org");
        pollTimeout = Integer.parseInt(p.getProperty("telegram.poll.timeout", "50"));

        ServletContext ctx = sce.getServletContext();
        synchronized (ctx) {
            if (ctx.getAttribute("tgOnboardingStarted") != null) return;
            ctx.setAttribute("tgOnboardingStarted", Boolean.TRUE);
        }

        running = true;
        loop = Executors.newSingleThreadExecutor(r -> {
            var t = new Thread(r, "tg-onboarding");
            t.setDaemon(true);
            return t;
        });
        loop.execute(this::pollLoop);
    }

    @Override
    public void contextDestroyed(ServletContextEvent sce) {
        running = false;
        if (loop != null) { loop.shutdownNow(); }
    }

    private void pollLoop() {
        HttpClient http = HttpClient.newBuilder()
            .connectTimeout(Duration.ofSeconds(10)).build();
        long offset = 0;
        long backoff = 1000;

        while (running && !Thread.currentThread().isInterrupted()) {
            try {
                String url = String.format("%s/bot%s/getUpdates?timeout=%d&offset=%d",
                    baseUrl, token, pollTimeout, offset);
                HttpRequest req = HttpRequest.newBuilder(URI.create(url))
                    .timeout(Duration.ofSeconds(Math.max(10, pollTimeout + 10)))
                    .GET().build();
                HttpResponse<String> res = http.send(req, HttpResponse.BodyHandlers.ofString());

                if (res.statusCode() != 200) {
                    throw new IOException("HTTP " + res.statusCode());
                }

                var root = om.readTree(res.body());
                if (root.path("ok").asBoolean(false)) {
                    for (var n : root.withArray("result")) {
                        long updateId = n.path("update_id").asLong();
                        handleStart(n);
                        offset = Math.max(offset, updateId + 1);
                    }
                }
                backoff = 1000;
            } catch (Exception e) {
                System.err.println("Telegram polling error: " + e.getMessage());
                try { Thread.sleep(backoff); }
                catch (InterruptedException ie) { Thread.currentThread().interrupt(); }
                backoff = Math.min(backoff * 2, 30000);
            }
        }
    }

    private void handleStart(JsonNode u) {
        var msg = u.get("message");
        if (msg == null || !msg.has("text")) return;
        String text = msg.get("text").asText("");
        if (!text.startsWith("/start")) return;

        String token = extractToken(text);
        if (token == null) return;
        long chatId  = msg.get("chat").get("id").asLong();
        long tgUser  = msg.get("from").get("id").asLong();

        SqlSession session = MyBatisSqlSessionFactory.getSqlSession();
        try {
            Integer userId = session.selectOne("TgLinkMapper.consumePending", token);
            if (userId != null) {
                session.update("TgLinkMapper.activate",
                    java.util.Map.of("userId", userId,
                                     "chatId", String.valueOf(chatId),
                                     "tgUserId", String.valueOf(tgUser)));
                session.commit();

                // í™˜ì˜ ë©”ì‹œì§€ ë°œì†¡
                new TelegramSender(loadProps("api.properties"))
                    .sendText(String.valueOf(chatId), "ğŸ‰ MEETLOG ì•Œë¦¼ ì—°ê²°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
            }
        } finally {
            session.close();
        }
    }

    private static String extractToken(String text){
        String[] parts = text.trim().split("\\s+");
        return parts.length >= 2 ? parts[1] : null;
    }

    private static Properties loadProps(String name) {
        try (InputStream in = Thread.currentThread().getContextClassLoader()
                .getResourceAsStream(name)) {
            Properties p = new Properties();
            if (in != null) p.load(in);
            return p;
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }

    private static String envOr(Properties p, String key, String envKey){
        String v = System.getenv(envKey);
        return (v != null && !v.isBlank()) ? v : p.getProperty(key);
    }
}
```

#### 4.4.2 web.xml ë¦¬ìŠ¤ë„ˆ ë“±ë¡
```xml
<!-- web.xml -->
<listener>
  <listener-class>telegram.OnboardingPoller</listener-class>
</listener>
```

### 4.5 ë©”ì‹œì§€ ë°œì†¡ API
```java
package telegram;

import java.net.URI;
import java.net.http.*;
import java.time.Duration;
import java.util.Properties;

public class TelegramSender {
    private final String token, baseUrl;
    private final HttpClient http = HttpClient.newBuilder()
        .connectTimeout(Duration.ofSeconds(10)).build();

    public TelegramSender(Properties p) {
        this.token  = p.getProperty("telegram.bot.token");
        this.baseUrl= p.getProperty("telegram.baseUrl", "https://api.telegram.org");
        if (token == null) throw new IllegalStateException("telegram.bot.token ëˆ„ë½");
    }

    public boolean sendText(String chatId, String text) {
        String url = baseUrl + "/bot" + token + "/sendMessage";
        String payload = "{\"chat_id\":\""+chatId+"\",\"text\":\""+escape(text)+"\"}";
        HttpRequest req = HttpRequest.newBuilder(URI.create(url))
            .header("Content-Type","application/json")
            .timeout(Duration.ofSeconds(10))
            .POST(HttpRequest.BodyPublishers.ofString(payload)).build();
        try {
            HttpResponse<Void> res = http.send(req, HttpResponse.BodyHandlers.discarding());
            if (res.statusCode() == 200) return true;
            if (res.statusCode() == 403) return false; // ì°¨ë‹¨/íƒˆí‡´
            if (res.statusCode() == 429) return false; // ì†ë„ ì œí•œ
            return false;
        } catch (Exception e) {
            System.err.println("Telegram send error: " + e.getMessage());
            return false;
        }
    }

    private static String escape(String s){
        return s.replace("\\","\\\\").replace("\"","\\\"");
    }
}
```

### 4.6 ì„œë¹„ìŠ¤ í†µí•© ë° ì´ë²¤íŠ¸ ì—°ê³„

#### 4.6.1 AlarmService
```java
package service;

import java.util.Properties;
import telegram.TelegramSender;
import org.apache.ibatis.session.SqlSession;
import util.MyBatisSqlSessionFactory;

public class AlarmService {
    private final TelegramSender sender;

    public AlarmService(Properties p){
        this.sender = new TelegramSender(p);
    }

    public void notifyMember(int userId, String message){
        SqlSession session = MyBatisSqlSessionFactory.getSqlSession();
        try {
            String chatId = session.selectOne("TgLinkMapper.findChatId", userId);
            if (chatId == null) return; // ë¯¸ì—°ê²°

            boolean ok = sender.sendText(chatId, message);
            if (!ok) {
                // 403 ë“± ë°œìƒ ì‹œ ìƒíƒœ ì „í™˜
                session.update("TgLinkMapper.markBlocked", userId);
                session.commit();
            }
        } finally {
            session.close();
        }
    }
}
```

#### 4.6.2 ì—°ê³„ ì§€ì  (ìƒì„¸ ì½”ë“œ)

**1) ê²°ì œ ì„±ê³µ ì•Œë¦¼**
```java
// NaverPayCallbackServlet.java - confirmResult.isSuccess() ë¸”ë¡
if (confirmResult.isSuccess()) {
    // ... ê¸°ì¡´ ì²˜ë¦¬

    // í…”ë ˆê·¸ë¨ ì•Œë¦¼ ë°œì†¡
    Properties p = util.AppConfig.getProperties();
    AlarmService alarmService = new AlarmService(p);
    alarmService.notifyMember(
        reservation.getUserId(),
        String.format("âœ… ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\nì˜ˆì•½: %s\në‚ ì§œ: %s\nê¸ˆì•¡: %,dì›",
            reservation.getRestaurantName(),
            reservation.getReservationTime(),
            reservation.getDepositAmount().intValue())
    );

    redirectSuccess(request, response);
}
```

**2) ì˜ˆì•½ ìƒíƒœ ë³€ê²½ ì•Œë¦¼**
```java
// BusinessReservationManagementServlet.java - ì˜ˆì•½ ìŠ¹ì¸ ì‹œ
@Override
protected void doPost(HttpServletRequest request, HttpServletResponse response)
        throws ServletException, IOException {
    String action = request.getParameter("action");
    int reservationId = Integer.parseInt(request.getParameter("reservationId"));

    if ("confirm".equals(action)) {
        reservationService.updateReservationStatus(reservationId, "CONFIRMED");
        Reservation res = reservationService.getReservationById(reservationId);

        // í…”ë ˆê·¸ë¨ ì•Œë¦¼
        AlarmService alarmService = new AlarmService(util.AppConfig.getProperties());
        alarmService.notifyMember(
            res.getUserId(),
            String.format("ğŸ‰ ì˜ˆì•½ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤!\n%s\n%s %dëª…",
                res.getRestaurantName(),
                res.getReservationTime(),
                res.getPartySize())
        );
    }
    // ...
}
```

**3) í¬ì¸íŠ¸ ì ë¦½ ì•Œë¦¼**
```java
// PointService.java - awardPoints ë©”ì„œë“œ ë§ˆì§€ë§‰ì—
public void awardPoints(int userId, int amount, String referenceType, Long referenceId) {
    // ... ê¸°ì¡´ ë¡œì§

    // ì•Œë¦¼ ë°œì†¡ (ë¹„ë™ê¸° ê¶Œì¥)
    CompletableFuture.runAsync(() -> {
        AlarmService alarmService = new AlarmService(util.AppConfig.getProperties());
        alarmService.notifyMember(
            userId,
            String.format("ğŸ’° í¬ì¸íŠ¸ %dPê°€ ì ë¦½ë˜ì—ˆìŠµë‹ˆë‹¤!\nêµ¬ë¶„: %s", amount, referenceType)
        );
    });
}
```

### 4.7 MyBatis ë§¤í¼
```xml
<!-- mappers/TgLinkMapper.xml -->
<mapper namespace="mapper.TgLinkMapper">
  <insert id="upsertPending">
    INSERT INTO tg_link (user_id, start_token, state)
    VALUES (#{userId}, #{token}, 'PENDING')
    ON DUPLICATE KEY UPDATE
      start_token = VALUES(start_token),
      state='PENDING',
      updated_at=NOW()
  </insert>

  <select id="consumePending" resultType="int">
    SELECT user_id FROM tg_link
    WHERE start_token = #{token} AND state='PENDING'
    FOR UPDATE
  </select>

  <update id="activate">
    UPDATE tg_link
       SET chat_id=#{chatId},
           tg_user_id=#{tgUserId},
           state='ACTIVE',
           updated_at=NOW()
     WHERE user_id=#{userId}
  </update>

  <select id="findChatId" resultType="string">
    SELECT chat_id FROM tg_link
    WHERE user_id=#{userId} AND state='ACTIVE'
  </select>

  <update id="markBlocked">
    UPDATE tg_link
    SET state='BLOCKED', updated_at=NOW()
    WHERE user_id=#{userId}
  </update>
</mapper>
```

### 4.8 ë³´ì•ˆ Â· êµ¬ì„± ì›ì¹™
- **Secrets ê´€ë¦¬**:
  - í™˜ê²½ë³€ìˆ˜ `TG_TOKEN`ì´ `api.properties` ë³´ë‹¤ ìš°ì„ 
  - `api.properties`ì—ëŠ” ìƒ˜í”Œ ê°’ë§Œ ì»¤ë°‹ (ì‹¤ì œ í† í°ì€ `.gitignore`)
- **ë„¤íŠ¸ì›Œí¬**: ë°©í™”ë²½ì—ì„œ `api.telegram.org:443` ì•„ì›ƒë°”ìš´ë“œ í—ˆìš©
- **ë¡œê¹…**:
  - 200 ì‘ë‹µì€ INFO ìƒëµ, 4xx/5xxë§Œ WARN/ERRORë¡œ ê¸°ë¡
  - SLF4J ì‚¬ìš© ê¶Œì¥: `log.error("Telegram send failed: {}", errorMessage)`

### 4.9 í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸
1. âœ… ë”¥ë§í¬ ë°œê¸‰ â†’ ì‘ë‹µ JSON `{"deepLink":"https://t.me/..."}` ê²€ì¦
2. âœ… `/start TOKEN` ì²˜ë¦¬ â†’ DB `tg_link.state=ACTIVE`, `chat_id` ì €ì¥ í™•ì¸
3. âœ… ì•Œë¦¼ ë°œì†¡ â†’ ì‹¤ì œ í…”ë ˆê·¸ë¨ ì•±ì—ì„œ ìˆ˜ì‹  ì—¬ë¶€ í™•ì¸
4. âœ… ì‚¬ìš©ì ì°¨ë‹¨ í›„ ë°œì†¡ â†’ 403 ê°ì§€ ë° `BLOCKED` ì „í™˜ í™•ì¸
5. âœ… ì¬ì˜¨ë³´ë”© â†’ ìƒˆ í† í° ë°œê¸‰ ë° ìƒíƒœ ë³µêµ¬ í™•ì¸

### 4.10 ì¥ì•  Â· ì˜ˆì™¸ ì²˜ë¦¬
- **ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜**: 1s â†’ 2s â†’ 4s â†’ â€¦ ìµœëŒ€ 30s ì§€ìˆ˜ ë°±ì˜¤í”„ í›„ ì¬ì‹œë„
- **429(ë ˆì´íŠ¸ ë¦¬ë°‹)**: ì‘ë‹µ í—¤ë” `Retry-After` í•´ì„ í›„ ëŒ€ê¸° (êµ¬í˜„ í•„ìš” ì‹œ)
- **403(ì°¨ë‹¨)**: `markBlocked`ë¡œ ìƒíƒœ ì „í™˜í•˜ê³  ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì— ì•Œë¦¼
- **í†°ìº£ ìë™ í¼ë¸”ë¦¬ì‹œ ì‹œ ë¦¬ìŠ¤ë„ˆ ì¤‘ë³µ ê¸°ë™ ë°©ì§€**: `tgOnboardingStarted` í”Œë˜ê·¸ ì‚¬ìš©

### 4.11 ìš´ì˜ íŒ
- ë©”ì‹œì§€ ê¸¸ì´ 4096ì ì´í•˜ ìœ ì§€, í•„ìš” ì‹œ ë¶„í•  ì „ì†¡
- ì„œì‹ì´ í•„ìš”í•˜ë©´ `parse_mode=HTML` ë˜ëŠ” `parse_mode=Markdown` ì˜µì…˜ ì¶”ê°€
- ê·¸ë£¹/ì±„ë„ ê³µì§€ëŠ” ë³„ë„ `chat_id` ì €ì¥ í›„ ë™ì¼ ë¡œì§ í™œìš©
- ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤ ìš´ì˜ ì‹œ í´ëŸ¬ëŠ” 1ê°œ ì¸ìŠ¤í„´ìŠ¤ë§Œ ê°€ë™í•˜ë„ë¡ ë¶„ì‚° ë½ ë˜ëŠ” ë¦¬ë” ì„ ì¶œ ì ìš©

### 4.12 êµ¬í˜„ ë‹¨ê³„ (ìƒì„¸)

| ë‹¨ê³„ | ì‘ì—… ë‚´ìš© | ìˆ˜ì •/ì¶”ê°€ íŒŒì¼ | í•µì‹¬ ì½”ë“œ | ê²€ì¦ ë°©ë²• |
|------|-----------|----------------|-----------|-----------|
| **1** | **í…”ë ˆê·¸ë¨ ë´‡ ìƒì„±** | - | BotFatherì—ì„œ `/newbot` ì‹¤í–‰, í† í° ë³µì‚¬ | `api.properties`ì— í† í° ì €ì¥ |
| **2** | **DB í…Œì´ë¸” ì¶”ê°€** | `database/master.sql` | ìƒê¸° 4.2 SQL | `DESCRIBE tg_link;` |
| **3** | **MyBatis ë§¤í¼ êµ¬í˜„** | `mappers/TgLinkMapper.xml` | ìƒê¸° 4.7 ì½”ë“œ | MyBatis ë¡œê·¸ í™•ì¸ |
| **4** | **í´ëŸ¬ ë¦¬ìŠ¤ë„ˆ êµ¬í˜„** | `telegram/OnboardingPoller.java` | ìƒê¸° 4.4.1 ì½”ë“œ | í†°ìº£ ì‹œì‘ ì‹œ ë¡œê·¸ `tg-onboarding thread started` í™•ì¸ |
| **5** | **web.xml ë¦¬ìŠ¤ë„ˆ ë“±ë¡** | `WEB-INF/web.xml` | ìƒê¸° 4.4.2 ì½”ë“œ | í†°ìº£ ì¬ì‹œì‘ í›„ í´ëŸ¬ ë™ì‘ í™•ì¸ |
| **6** | **TelegramSender êµ¬í˜„** | `telegram/TelegramSender.java` | ìƒê¸° 4.5 ì½”ë“œ | ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¡œ sendText í˜¸ì¶œ |
| **7** | **AlarmService êµ¬í˜„** | `service/AlarmService.java` | ìƒê¸° 4.6.1 ì½”ë“œ | JUnitìœ¼ë¡œ notifyMember í…ŒìŠ¤íŠ¸ |
| **8** | **í† í° ë°œê¸‰ ì„œë¸”ë¦¿** | `controller/telegram/TelegramLinkServlet.java` | ìƒê¸° 4.3.2 ì½”ë“œ | Postmanìœ¼ë¡œ `/member/telegram/link` í…ŒìŠ¤íŠ¸ |
| **9** | **ë§ˆì´í˜ì´ì§€ UI** | `WEB-INF/views/mypage.jsp` | ìƒê¸° 4.3.3 ì½”ë“œ | ë¸Œë¼ìš°ì €ì—ì„œ ì—°ê²° ë²„íŠ¼ í´ë¦­ â†’ ë”¥ë§í¬ ìƒì„± í™•ì¸ |
| **10** | **ê²°ì œ ì„±ê³µ ì•Œë¦¼ ì—°ë™** | `controller/payment/NaverPayCallbackServlet.java` | ìƒê¸° 4.6.2(1) ì½”ë“œ | ê²°ì œ í›„ í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ìˆ˜ì‹  í™•ì¸ |
| **11** | **ì˜ˆì•½ ìŠ¹ì¸ ì•Œë¦¼ ì—°ë™** | `controller/BusinessReservationManagementServlet.java` | ìƒê¸° 4.6.2(2) ì½”ë“œ | ì˜ˆì•½ ìŠ¹ì¸ í›„ ì•Œë¦¼ ìˆ˜ì‹  í™•ì¸ |
| **12** | **í¬ì¸íŠ¸ ì ë¦½ ì•Œë¦¼ ì—°ë™** | `service/PointService.java` | ìƒê¸° 4.6.2(3) ì½”ë“œ | í¬ì¸íŠ¸ ì ë¦½ í›„ ì•Œë¦¼ ìˆ˜ì‹  í™•ì¸ |

---

## 5. ì¼ì • ë° ë¦¬ìŠ¤í¬

### 5.1 ì˜ˆìƒ ì†Œìš” ê¸°ê°„
| ê¸°ëŠ¥ | ê°œë°œ ê¸°ê°„ | í…ŒìŠ¤íŠ¸ ê¸°ê°„ | ì´ ì†Œìš” |
|------|-----------|-------------|---------|
| **ì¿ í° ê¸°ëŠ¥ ë³´ì™„** | 1ì£¼ | 0.5ì£¼ | **1.5ì£¼** |
| **í¬ì¸íŠ¸ ì‹œìŠ¤í…œ** | 2ì£¼ | 1ì£¼ | **3ì£¼** |
| **í…”ë ˆê·¸ë¨ ì—°ë™** | 0.5ì£¼ | 0.5ì£¼ | **1ì£¼** |
| **í†µí•© í…ŒìŠ¤íŠ¸ & ë²„ê·¸ ìˆ˜ì •** | - | 1ì£¼ | **1ì£¼** |
| **ì´ê³„** | - | - | **6.5ì£¼** |

### 5.2 Phaseë³„ ìš°ì„ ìˆœìœ„
- **Phase 1 (2ì£¼)**: ì¿ í° ì‚¬ìš© ì™„ì„± (ì˜ˆì•½ ì—°ë™, ë¡¤ë°± ì²˜ë¦¬)
- **Phase 2 (3ì£¼)**: í¬ì¸íŠ¸ ì ë¦½/ì‚¬ìš© (ê²°ì œ ì—°ë™, UI)
- **Phase 3 (1ì£¼)**: í…”ë ˆê·¸ë¨ ì˜¨ë³´ë”© (í´ëŸ¬ëŠ” ì´ë¯¸ ì½”ë“œ ì™„ì„±ë¨)
- **Phase 4 (0.5ì£¼)**: í†µí•© í…ŒìŠ¤íŠ¸ & ë²„ê·¸ ìˆ˜ì •

### 5.3 ë¦¬ìŠ¤í¬ ìš”ì¸ ë° ëŒ€ì‘
| ë¦¬ìŠ¤í¬ | ì˜í–¥ë„ | ëŒ€ì‘ ë°©ì•ˆ |
|--------|--------|-----------|
| **ê²°ì œ/ì˜ˆì•½ ë¡œì§ ë³µì¡ë„** | ë†’ìŒ | ìë™í™” í…ŒìŠ¤íŠ¸/QA ê³„íš ìˆ˜ë¦½, ë‹¨ê³„ë³„ ì½”ë“œ ë¦¬ë·° |
| **í¬ì¸íŠ¸Â·ì¿ í°Â·í…”ë ˆê·¸ë¨ ì •ì‚° ì´ìŠˆ** | ì¤‘ê°„ | ë¹„ì¦ˆë‹ˆìŠ¤ ë¶€ì„œ í˜‘ì˜, íšŒê³„ íŒ€ ê²€ì¦ |
| **ë™ì‹œì„± ë²„ê·¸ (í¬ì¸íŠ¸ ì”ì•¡)** | ë†’ìŒ | ë¶€í•˜ í…ŒìŠ¤íŠ¸ (JMeter), íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ ì¡°ì • |
| **í…”ë ˆê·¸ë¨ ë ˆì´íŠ¸ ë¦¬ë°‹(429)** | ë‚®ìŒ | ë°±ì˜¤í”„ ë¡œì§ êµ¬í˜„, ë°œì†¡ í ë„ì… (ì„ íƒ) |
| **ì‚¬ìš©ì ì°¨ë‹¨(403) ì²˜ë¦¬ ëˆ„ë½** | ì¤‘ê°„ | ìƒíƒœ ì „í™˜ ë¡œì§ í•„ìˆ˜ êµ¬í˜„, ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ |

---

## 6. ê¶Œì¥ ì„ í–‰ ì‘ì—…

### 6.1 ê°œë°œ í™˜ê²½ ì¤€ë¹„
1. âœ… **í…ŒìŠ¤íŠ¸/ìŠ¤í…Œì´ì§• DB ìŠ¤ëƒ…ìƒ· í™•ë³´**
   - ìš´ì˜ DB ë¤í”„ â†’ `database/backup/`
   - ë§ˆì´ê·¸ë ˆì´ì…˜ ë²„ì „ ê´€ë¦¬ (Flyway ë˜ëŠ” ìˆ˜ë™ ìŠ¤í¬ë¦½íŠ¸)
2. âœ… **MyBatis ë¡œê¹… ë ˆë²¨ ì¡°ì •**
   ```xml
   <!-- mybatis-config.xml -->
   <settings>
     <setting name="logImpl" value="SLF4J"/>
   </settings>
   ```
   ```xml
   <!-- logback.xml (resources/) -->
   <logger name="mapper" level="DEBUG"/>
   ```
3. âœ… **JUnit 5 + MyBatis Test í™˜ê²½ êµ¬ì¶•**
   ```xml
   <!-- pom.xml -->
   <dependency>
     <groupId>org.junit.jupiter</groupId>
     <artifactId>junit-jupiter</artifactId>
     <version>5.10.0</version>
     <scope>test</scope>
   </dependency>
   ```

### 6.2 ì •ì±… ë¬¸ì„œí™”
1. í¬ì¸íŠ¸ ë° ì¿ í° ì •ì±… í™•ì •
   - ì ë¦½ë¥ : ê²°ì œ ê¸ˆì•¡ì˜ 5%
   - í¬ì¸íŠ¸ ë§Œë£Œ: 1ë…„
   - ì¿ í° ì¤‘ë³µ ì‚¬ìš©: ë¶ˆê°€ (1íšŒë‹¹ 1ê°œ)
   - ìµœì†Œ ì‚¬ìš© í¬ì¸íŠ¸: 100P
2. í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ í…œí”Œë¦¿ ì •ì˜
   ```
   - ê²°ì œ ì„±ê³µ: "âœ… ê²°ì œ ì™„ë£Œ! ì˜ˆì•½: {restaurant}, ë‚ ì§œ: {date}, ê¸ˆì•¡: {amount}ì›"
   - ì˜ˆì•½ ìŠ¹ì¸: "ğŸ‰ ì˜ˆì•½ í™•ì •! {restaurant} {date} {partySize}ëª…"
   - í¬ì¸íŠ¸ ì ë¦½: "ğŸ’° í¬ì¸íŠ¸ {amount}P ì ë¦½! êµ¬ë¶„: {type}"
   ```

### 6.3 QA ì‹œë‚˜ë¦¬ì˜¤ ì‘ì„±
- **ì¿ í° í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤** (15ê°œ):
  1. ìœ íš¨í•œ ì¿ í° ì‚¬ìš© ì„±ê³µ
  2. ë§Œë£Œëœ ì¿ í° ì‚¬ìš© ì‹¤íŒ¨
  3. ì‚¬ìš© íšŸìˆ˜ ì´ˆê³¼ ì‹¤íŒ¨
  4. ìµœì†Œ ì£¼ë¬¸ ê¸ˆì•¡ ë¯¸ë‹¬ ì‹¤íŒ¨
  5. ë‹¤ë¥¸ ì‚¬ìš©ì ì¿ í° ë„ìš© ì‹œë„ ì°¨ë‹¨
  6. ê²°ì œ ì‹¤íŒ¨ ì‹œ ì¿ í° ë¡¤ë°±
  7. ... (ì¶”ê°€ 9ê°œ)

- **í¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤** (20ê°œ):
  1. ê²°ì œ ì„±ê³µ ì‹œ 5% ì ë¦½
  2. í¬ì¸íŠ¸ ì‚¬ìš© í›„ ì”ì•¡ ì°¨ê°
  3. ì”ì•¡ ë¶€ì¡± ì‹œ ì—ëŸ¬
  4. ë™ì‹œ ìš”ì²­ ì‹œ ì •í•©ì„± (10ê°œ ìŠ¤ë ˆë“œ í…ŒìŠ¤íŠ¸)
  5. ... (ì¶”ê°€ 16ê°œ)

### 6.4 ìš´ì˜ ì¤€ë¹„
1. **ëª¨ë‹ˆí„°ë§ ë„êµ¬**:
   - í…”ë ˆê·¸ë¨ ë°œì†¡ ì‹¤íŒ¨ìœ¨ ëª¨ë‹ˆí„°ë§ (Prometheus + Grafana)
   - í¬ì¸íŠ¸ ì”ì•¡ ë¶ˆì¼ì¹˜ ì•Œë¦¼ (ì¼ 1íšŒ ë°°ì¹˜ ê²€ì¦)
2. **ë°±ì—… ì •ì±…**:
   - `user_points`, `point_transactions` í…Œì´ë¸” ì¼ 1íšŒ ë°±ì—…
   - í…”ë ˆê·¸ë¨ `tg_link` í…Œì´ë¸” ì£¼ 1íšŒ ë°±ì—…

---

## 7. ë¡¤ë°± ë° ë³µêµ¬ ì‹œë‚˜ë¦¬ì˜¤

### 7.1 ì¿ í° ë¡¤ë°± ì‹œë‚˜ë¦¬ì˜¤

#### 7.1.1 ê²°ì œ ì‹¤íŒ¨ ì‹œ
```java
// NaverPayCallbackServlet.handleFailure
if (reservation.getUserCouponId() != null) {
    // ì¿ í° ì‚¬ìš© ì „ìœ¼ë¡œ ë³µì› (is_used=0) - ë‹¨, ê²°ì œ ì „ì—ëŠ” ë³€ê²½ ì•ˆ í–ˆìœ¼ë¯€ë¡œ ìƒëµ ê°€ëŠ¥
    // ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  ë‹¤ìŒ ì‚¬ìš© ì‹œ ì¬ê²€ì¦ìœ¼ë¡œ ì²˜ë¦¬
    log.warn("ê²°ì œ ì‹¤íŒ¨ë¡œ ì¿ í° ì‚¬ìš© ì·¨ì†Œ: userCouponId={}", reservation.getUserCouponId());
}
```

#### 7.1.2 ì¤‘ë³µ ì‚¬ìš© ë°©ì§€
```sql
-- íŠ¸ë¦¬ê±°ë¡œ ì¤‘ë³µ ì‚¬ìš© ê°ì§€ (ì„ íƒ ì‚¬í•­)
DELIMITER //
CREATE TRIGGER prevent_duplicate_coupon_use
BEFORE UPDATE ON user_coupons
FOR EACH ROW
BEGIN
    IF NEW.is_used = 1 AND OLD.is_used = 1 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'ì´ë¯¸ ì‚¬ìš©ëœ ì¿ í°ì…ë‹ˆë‹¤';
    END IF;
END//
DELIMITER ;
```

### 7.2 í¬ì¸íŠ¸ ë¡¤ë°± ì‹œë‚˜ë¦¬ì˜¤

#### 7.2.1 ê²°ì œ ì·¨ì†Œ ì‹œ í¬ì¸íŠ¸ í™˜ë¶ˆ
```java
// ReservationService.cancelReservation
public boolean cancelReservation(int reservationId, String cancelReason) {
    SqlSession session = MyBatisSqlSessionFactory.getSqlSession();
    try {
        Reservation res = session.selectOne("ReservationMapper.findById", reservationId);

        // í¬ì¸íŠ¸ ì‚¬ìš©í–ˆë‹¤ë©´ í™˜ë¶ˆ
        if (res.getPointsUsed() > 0) {
            pointService.refundPoints(
                res.getUserId(),
                res.getPointsUsed(),
                "CANCEL",
                (long) reservationId
            );
        }

        // í¬ì¸íŠ¸ ì ë¦½í–ˆë‹¤ë©´ ì°¨ê° (ë§ˆì´ë„ˆìŠ¤ ê±°ë˜ ê¸°ë¡)
        if (res.getPointsEarned() > 0) {
            pointService.redeemPoints(
                res.getUserId(),
                res.getPointsEarned(),
                "CANCEL",
                (long) reservationId
            );
        }

        // ì˜ˆì•½ ì·¨ì†Œ
        res.setStatus("CANCELLED");
        res.setCancelReason(cancelReason);
        res.setCancelledAt(LocalDateTime.now());
        session.update("ReservationMapper.update", res);

        session.commit();
        return true;
    } catch (Exception e) {
        session.rollback();
        throw e;
    } finally {
        session.close();
    }
}
```

#### 7.2.2 ë°ì´í„° ì •í•©ì„± ê²€ì¦ ë°°ì¹˜
```java
// batch/PointIntegrityCheckJob.java (Quartz Job)
public void execute(JobExecutionContext context) {
    SqlSession session = MyBatisSqlSessionFactory.getSqlSession();
    try {
        List<Integer> userIds = session.selectList("UserMapper.findAllUserIds");

        for (int userId : userIds) {
            // 1. user_points.balance ì¡°íšŒ
            Integer dbBalance = session.selectOne("PointMapper.getBalance", userId);

            // 2. point_transactions í•©ê³„ ê³„ì‚°
            Integer calculatedBalance = session.selectOne("PointMapper.sumTransactions", userId);

            // 3. ë¶ˆì¼ì¹˜ ì‹œ ì•Œë¦¼
            if (dbBalance != null && calculatedBalance != null &&
                !dbBalance.equals(calculatedBalance)) {
                log.error("í¬ì¸íŠ¸ ì”ì•¡ ë¶ˆì¼ì¹˜ ë°œê²¬! userId={}, DB={}, ê³„ì‚°={}",
                    userId, dbBalance, calculatedBalance);

                // ê´€ë¦¬ì ì•Œë¦¼ (í…”ë ˆê·¸ë¨ ë˜ëŠ” ì´ë©”ì¼)
                alarmService.notifyAdmin(String.format(
                    "âš ï¸ í¬ì¸íŠ¸ ë¶ˆì¼ì¹˜: ì‚¬ìš©ì %d, DB=%d, ê³„ì‚°=%d",
                    userId, dbBalance, calculatedBalance));
            }
        }
    } finally {
        session.close();
    }
}
```

### 7.3 í…”ë ˆê·¸ë¨ ì—°ê²° ë³µêµ¬ ì‹œë‚˜ë¦¬ì˜¤

#### 7.3.1 ì°¨ë‹¨(BLOCKED) ìƒíƒœ ë³µêµ¬
```java
// TelegramLinkServlet - ì¬ì—°ê²° ìš”ì²­
@Override
protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws IOException {
    // ... (ê¸°ì¡´ ë¡œì§ê³¼ ë™ì¼)

    // ì°¨ë‹¨ ìƒíƒœì—¬ë„ ìƒˆ í† í° ë°œê¸‰ìœ¼ë¡œ ì¬ì˜¨ë³´ë”© ê°€ëŠ¥
    sqlSession.update("TgLinkMapper.upsertPending",
        Map.of("userId", userId, "token", token));
    // stateê°€ PENDINGìœ¼ë¡œ ë³€ê²½ë˜ì–´ ì¬ì‹œì‘ ê°€ëŠ¥
}
```

#### 7.3.2 ë°œì†¡ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ í (ì„ íƒ ì‚¬í•­)
```java
// AlarmService - ì¬ì‹œë„ ë¡œì§
public void notifyMemberWithRetry(int userId, String message, int maxRetries) {
    for (int i = 0; i < maxRetries; i++) {
        if (notifyMember(userId, message)) {
            return; // ì„±ê³µ
        }
        try { Thread.sleep(1000 * (i + 1)); } // ì§€ìˆ˜ ë°±ì˜¤í”„
        catch (InterruptedException e) { Thread.currentThread().interrupt(); }
    }
    log.error("í…”ë ˆê·¸ë¨ ë°œì†¡ ìµœì¢… ì‹¤íŒ¨: userId={}, message={}", userId, message);
}
```

---

## 8. í–¥í›„ í™•ì¥ ì•„ì´ë””ì–´

### 8.1 ì¿ í° & í¬ì¸íŠ¸ í†µí•©
- **í†µí•© í˜œíƒ ë¶„ì„ ëŒ€ì‹œë³´ë“œ**: ì‚¬ìš©ìë³„ ì¿ í°/í¬ì¸íŠ¸ ì‚¬ìš© íŒ¨í„´ ì‹œê°í™”
- **ìë™ ì¿ í° ì¶”ì²œ**: ì‚¬ìš©ì ì˜ˆì•½ ì´ë ¥ ê¸°ë°˜ ë§ì¶¤ ì¿ í° ì¶”ì²œ (KoBERT ì—°ë™)
- **í¬ì¸íŠ¸ ì„ ë¬¼ ê¸°ëŠ¥**: ì‚¬ìš©ì ê°„ í¬ì¸íŠ¸ ì´ì²´

### 8.2 ERP/ì§€ì  ì‹œìŠ¤í…œ ì—°ë™
- í¬ì¸íŠ¸ ê³µìœ : ë³¸ì /ì§€ì  í†µí•© í¬ì¸íŠ¸ ê³„ì¢Œ
- ì§€ì ë³„ ì¿ í° ë°œê¸‰: ERPì—ì„œ ì§€ì  ê´€ë¦¬ìê°€ ë…ë¦½ì ìœ¼ë¡œ ì¿ í° ìƒì„±

### 8.3 ì¶”ì²œ ì‹œìŠ¤í…œ ê²°í•©
- **ë§ì¶¤í˜• ìº í˜ì¸ ìë™í™”**:
  1. KoBERTë¡œ ì‚¬ìš©ì ì·¨í–¥ ë¶„ì„
  2. ì·¨í–¥ ë§ëŠ” ë ˆìŠ¤í† ë‘ ì¿ í° ìë™ ë°œê¸‰
  3. í…”ë ˆê·¸ë¨ìœ¼ë¡œ ì¿ í° ì•ˆë‚´ ë©”ì‹œì§€ ë°œì†¡

### 8.4 ë©”ì‹œì§€ í ë„ì…
- **ëŒ€ëŸ‰ ë°œì†¡ ê´€ë¦¬**: RabbitMQ ë˜ëŠ” Kafkaë¡œ í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ íì‰
- **ì¬ì‹œë„ ì •ì±…**: Dead Letter Queueë¡œ ì‹¤íŒ¨ ë©”ì‹œì§€ ì¬ì²˜ë¦¬

---

## 9. ë¶€ë¡

### 9.1 ì°¸ê³  ìë£Œ
- MyBatis ê³µì‹ ë¬¸ì„œ: https://mybatis.org/mybatis-3/
- Telegram Bot API: https://core.telegram.org/bots/api
- Java 11 HttpClient: https://docs.oracle.com/en/java/javase/11/docs/api/java.net.http/java/net/http/HttpClient.html

### 9.2 ì½”ë“œ ìŠ¤ë‹ˆí« ëª¨ìŒ
- ì¿ í° ê²€ì¦ ìœ í‹¸: `UserCouponService.validateCouponUsable`
- í¬ì¸íŠ¸ ë™ì‹œì„± í…ŒìŠ¤íŠ¸: `PointServiceTest.í¬ì¸íŠ¸_ë™ì‹œ_ì°¨ê°_í…ŒìŠ¤íŠ¸`
- í…”ë ˆê·¸ë¨ í´ëŸ¬: `OnboardingPoller.pollLoop`
- ì•Œë¦¼ ë°œì†¡: `AlarmService.notifyMember`

### 9.3 ìš©ì–´ ì •ì˜
- **ì¿ í°**: í• ì¸ í˜œíƒì„ ì œê³µí•˜ëŠ” í”„ë¡œëª¨ì…˜ ë„êµ¬
- **í¬ì¸íŠ¸**: ì‚¬ìš©ì í™œë™ ì ë¦½ê¸ˆ, 1P = 1ì›
- **ì˜¨ë³´ë”©**: í…”ë ˆê·¸ë¨ ë´‡ `/start` ë”¥ë§í¬ë¥¼ í†µí•œ chat_id ë“±ë¡ ê³¼ì •
- **í´ëŸ¬**: Long Polling ë°©ì‹ìœ¼ë¡œ í…”ë ˆê·¸ë¨ APIì—ì„œ ë©”ì‹œì§€ ìˆ˜ì‹ 
- **ë¡¤ë°±**: ê±°ë˜ ì‹¤íŒ¨ ì‹œ ì›ë˜ ìƒíƒœë¡œ ë³µì›

---

**ì‘ì„±ì**: MEETLOG ê°œë°œíŒ€
**ìµœì¢… ìˆ˜ì •ì¼**: 2025-10-10
**ë²„ì „**: 2.0 (ì–¼ìŒë³„ ëŒ€ëª¨í—˜)
