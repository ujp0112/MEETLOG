<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dao.FollowDAO">
    <resultMap id="followResultMap" type="model.Follow" autoMapping="true">
        <id property="followId" column="follow_id" />
        <result property="followerId" column="follower_id" />
        <result property="followingId" column="following_id" />
        <result property="createdAt" column="created_at" />
        <result property="followerNickname" column="follower_nickname" />
        <result property="followerProfileImage" column="follower_profile_image" />
        <result property="followingNickname" column="following_nickname" />
        <result property="followingProfileImage" column="following_profile_image" />
    </resultMap>

    <insert id="follow" parameterType="map">
        INSERT INTO follows (follower_id, following_id)
        VALUES (#{followerId}, #{followingId})
        ON DUPLICATE KEY UPDATE created_at = NOW()
    </insert>
    
    <delete id="unfollow" parameterType="map">
        DELETE FROM follows 
        WHERE follower_id = #{followerId} AND following_id = #{followingId}
    </delete>
    
    <select id="isFollowing" parameterType="map" resultType="int">
        SELECT COUNT(*) 
        FROM follows 
        WHERE follower_id = #{followerId} AND following_id = #{followingId}
    </select>
    
    <select id="getFollowings" parameterType="int" resultMap="followResultMap">
        SELECT 
            f.*,
            u.nickname as following_nickname,
            u.profile_image as following_profile_image
        FROM follows f
        INNER JOIN users u ON f.following_id = u.id
        WHERE f.follower_id = #{userId}
        ORDER BY f.created_at DESC
    </select>
    
    <select id="getFollowers" parameterType="int" resultMap="followResultMap">
        SELECT 
            f.*,
            u.nickname as follower_nickname,
            u.profile_image as follower_profile_image
        FROM follows f
        INNER JOIN users u ON f.follower_id = u.id
        WHERE f.following_id = #{userId}
        ORDER BY f.created_at DESC
    </select>
    
    <select id="getFollowingCount" parameterType="int" resultType="int">
        SELECT COUNT(*) FROM follows WHERE follower_id = #{userId}
    </select>
    
    <select id="getFollowerCount" parameterType="int" resultType="int">
        SELECT COUNT(*) FROM follows WHERE following_id = #{userId}
    </select>
    
    <select id="getFollowingIds" parameterType="int" resultType="int">
        SELECT following_id FROM follows WHERE follower_id = #{userId}
    </select>
</mapper>