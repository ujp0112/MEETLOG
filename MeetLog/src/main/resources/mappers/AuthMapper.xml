<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.AuthMapper">
  <resultMap id="AppUserMap" type="dto.AppUser">
    <id property="id" column="id"/>
    <result property="companyId" column="company_id"/>
    <result property="branchId" column="branch_id"/>
    <result property="role" column="role"/>
    <result property="email" column="email"/>
    <result property="pwHash" column="pw_hash"/>
    <result property="activeYn" column="active_yn"/>
    <result property="name" column="name"/>
  </resultMap>

  <select id="findByEmail" parameterType="map" resultMap="AppUserMap">
    SELECT * FROM app_user WHERE email=#{email} AND active_yn='Y' LIMIT 1
  </select>

  <select id="findHqByIdentifier" parameterType="map" resultMap="AppUserMap">
    SELECT u.* FROM app_user u
    WHERE u.role='HQ'
      AND (u.email=#{identifier} OR u.id=#{identifier})
      AND u.active_yn='Y'
    LIMIT 1
  </select>

  <insert id="insertCompany" useGeneratedKeys="true" keyProperty="id" parameterType="dto.Company">
    INSERT INTO company (name) VALUES (#{name})
  </insert>

  <insert id="insertBranch" useGeneratedKeys="true" keyProperty="id" parameterType="dto.Branch">
    INSERT INTO branch (company_id, name, active_yn)
    VALUES (#{companyId}, #{name}, #{activeYn})
  </insert>

  <insert id="insertUser" useGeneratedKeys="true" keyProperty="id" parameterType="dto.AppUser">
    INSERT INTO app_user (company_id, branch_id, role, email, pw_hash, active_yn)
    VALUES (#{companyId}, #{branchId}, #{role}, #{email}, #{pwHash}, #{activeYn})
  </insert>
</mapper>
