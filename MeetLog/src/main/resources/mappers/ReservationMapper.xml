<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dao.ReservationDAO">
    <resultMap id="reservationResultMap" type="Reservation" autoMapping="true">
        <id property="id" column="id" />
        <result property="restaurantId" column="restaurant_id" />
        <result property="userId" column="user_id" />
        <result property="customerName" column="customer_name" />
        <result property="customerPhone" column="customer_phone" />
        <result property="reservationDate" column="reservation_time" />
        <result property="reservationTime" column="reservation_time" />
        <result property="partySize" column="party_size" />
        <result property="specialRequests" column="special_requests" />
        <result property="createdAt" column="created_at" />
        <result property="updatedAt" column="updated_at" />
    </resultMap>
    
    <resultMap id="reservationStatsResultMap" type="service.ReservationService$ReservationStats" autoMapping="true">
        <result property="totalReservations" column="total_reservations" />
        <result property="pendingReservations" column="pending_reservations" />
        <result property="confirmedReservations" column="confirmed_reservations" />
        <result property="cancelledReservations" column="cancelled_reservations" />
        <result property="completedReservations" column="completed_reservations" />
    </resultMap>

    <!-- 음식점별 예약 목록 조회 -->
    <select id="findByRestaurantId" resultMap="reservationResultMap">
        SELECT r.*, u.nickname as customer_name
        FROM reservations r
        LEFT JOIN users u ON r.user_id = u.id
        WHERE r.restaurant_id = #{restaurantId}
        ORDER BY r.reservation_time DESC
    </select>

    <!-- 예약 상세 조회 -->
    <select id="findById" resultMap="reservationResultMap">
        SELECT r.*, u.nickname as customer_name
        FROM reservations r
        LEFT JOIN users u ON r.user_id = u.id
        WHERE r.id = #{reservationId}
    </select>

    <!-- 예약 상태 변경 -->
    <update id="updateStatus">
        UPDATE reservations 
        SET status = #{status}, updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- 예약 삭제 -->
    <delete id="delete">
        DELETE FROM reservations WHERE id = #{reservationId}
    </delete>

    <!-- 오늘 예약 목록 조회 -->
    <select id="findTodayReservations" resultMap="reservationResultMap">
        SELECT r.*, u.nickname as customer_name
        FROM reservations r
        LEFT JOIN users u ON r.user_id = u.id
        WHERE r.restaurant_id = #{restaurantId}
        AND DATE(r.reservation_time) = CURDATE()
        ORDER BY r.reservation_time ASC
    </select>

    <!-- 예약 통계 조회 -->
    <select id="getReservationStats" resultMap="reservationStatsResultMap">
        SELECT 
            COUNT(*) as total_reservations,
            SUM(CASE WHEN status = 'PENDING' THEN 1 ELSE 0 END) as pending_reservations,
            SUM(CASE WHEN status = 'CONFIRMED' THEN 1 ELSE 0 END) as confirmed_reservations,
            SUM(CASE WHEN status = 'CANCELLED' THEN 1 ELSE 0 END) as cancelled_reservations,
            SUM(CASE WHEN status = 'COMPLETED' THEN 1 ELSE 0 END) as completed_reservations
        FROM reservations 
        WHERE restaurant_id = #{restaurantId}
    </select>

    <!-- 예약 생성 -->
    <insert id="insert" parameterType="Reservation" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO reservations (
            restaurant_id, user_id, customer_name, customer_phone,
            reservation_time, party_size, status,
            special_requests, created_at, updated_at
        ) VALUES (
            #{restaurantId}, #{userId}, #{customerName}, #{customerPhone},
            #{reservationDate}, #{reservationTime}, #{partySize}, #{status},
            #{specialRequests}, NOW(), NOW()
        )
    </insert>

    <!-- 고급 검색을 위한 예약 검색 -->
    <select id="searchReservations" resultMap="reservationResultMap">
        SELECT r.*, u.nickname as customer_name
        FROM reservations r
        LEFT JOIN users u ON r.user_id = u.id
        LEFT JOIN restaurants rest ON r.restaurant_id = rest.id
        WHERE 1=1
        <if test="restaurantId != null">
            AND r.restaurant_id = #{restaurantId}
        </if>
        <if test="status != null and status != ''">
            AND r.status = #{status}
        </if>
        <if test="customerName != null and customerName != ''">
            AND u.nickname LIKE CONCAT('%', #{customerName}, '%')
        </if>
        <if test="startDate != null and startDate != ''">
            AND r.reservation_time >= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND r.reservation_time &lt;= #{endDate}
        </if>
        ORDER BY r.reservation_time DESC
    </select>
</mapper>