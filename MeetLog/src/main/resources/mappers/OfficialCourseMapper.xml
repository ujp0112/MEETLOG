<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.OfficialCourseMapper">

    <resultMap id="officialCourseWithStepsResult" type="model.OfficialCourse">
        <id property="id" column="course_id"/>
        <result property="title" column="course_title"/>
        
        <collection property="tags" javaType="java.util.ArrayList"
                    select="selectTagsForCourse" column="course_id"/>
        
        <collection property="steps" ofType="model.CourseStep">
            <id property="id" column="step_id"/>
            <result property="type" column="step_type"/>
            <result property="emoji" column="step_emoji"/>
            <result property="name" column="step_name"/>
            <result property="description" column="step_description"/>
            <result property="image" column="step_image"/>
        </collection>
    </resultMap>

    <select id="selectOfficialCourses" resultMap="officialCourseWithStepsResult">
        SELECT 
            c.course_id, 
            c.title AS course_title,
            cs.step_id,
            cs.step_type,
            cs.emoji AS step_emoji,
            cs.name AS step_name,
            cs.description AS step_description,
            cs.image AS step_image
        FROM courses c
        LEFT JOIN course_steps cs ON c.course_id = cs.course_id
        WHERE c.type = 'OFFICIAL'
        ORDER BY c.created_at DESC, cs.step_order ASC
    </select>
    
    <select id="selectTagsForCourse" parameterType="int" resultType="java.lang.String">
        SELECT t.tag_name FROM course_tags ct
        JOIN tags t ON ct.tag_id = t.tag_id
        WHERE ct.course_id = #{course_id}
    </select>
    
    </mapper>