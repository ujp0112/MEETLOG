<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.OfficialCourseMapper">

    <resultMap id="officialCourseResult" type="model.OfficialCourse">
        <id property="id" column="course_id"/>
        <result property="title" column="title"/>
        <collection property="tags" javaType="java.util.ArrayList"
                    select="selectTagsForCourse" column="course_id"/>
        <collection property="steps" javaType="java.util.ArrayList"
                    ofType="model.CourseStep"
                    select="selectStepsForCourse" column="course_id"/>
    </resultMap>
    
    <resultMap id="stepResult" type="model.CourseStep">
        <result property="type" column="step_type"/>
        <result property="emoji" column="emoji"/>
        <result property="name" column="name"/>
        <result property="description" column="description"/>
        <result property="image" column="image"/>
    </resultMap>

    <select id="selectOfficialCourses" resultMap="officialCourseResult">
        SELECT course_id, title 
        FROM courses
        WHERE type = 'OFFICIAL'
        ORDER BY created_at DESC
    </select>
    
    <select id="selectTagsForCourse" parameterType="int" resultType="java.lang.String">
        SELECT t.tag_name FROM course_tags ct
        JOIN tags t ON ct.tag_id = t.tag_id
        WHERE ct.course_id = #{course_id}
    </select>
    
    <select id="selectStepsForCourse" parameterType="int" resultMap="stepResult">
        SELECT step_type, emoji, name, description, image
        FROM course_steps
        WHERE course_id = #{course_id}
        ORDER BY step_order ASC
    </select>
</mapper>