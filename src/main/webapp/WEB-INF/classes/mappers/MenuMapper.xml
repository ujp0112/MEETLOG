<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.meetlog.mapper.MenuMapper">
  <resultMap id="MenuMap" type="com.meetlog.dto.Menu">
    <id property="id" column="id"/>
    <result property="companyId" column="company_id"/>
    <result property="name" column="name"/>
    <result property="price" column="price"/>
    <result property="imgPath" column="img_path"/>
    <result property="activeYn" column="active_yn"/>
    <result property="deletedYn" column="deleted_yn"/>
  </resultMap>

  <resultMap id="MenuIngredientMap" type="com.meetlog.dto.MenuIngredient">
    <result property="companyId" column="company_id"/>
    <result property="menuId" column="menu_id"/>
    <result property="materialId" column="material_id"/>
    <result property="qty" column="qty"/>
    <result property="materialName" column="material_name"/>
    <result property="unit" column="unit"/>
    <result property="unitPrice" column="unit_price"/>
  </resultMap>

  <select id="listMenus" parameterType="map" resultMap="MenuMap">
    SELECT * FROM menu
    WHERE company_id=#{companyId} AND deleted_yn='N'
    ORDER BY name
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <insert id="insertMenu" useGeneratedKeys="true" keyProperty="id" parameterType="com.meetlog.dto.Menu">
    INSERT INTO menu (company_id, name, price, img_path, active_yn, deleted_yn)
    VALUES (#{companyId}, #{name}, #{price}, #{imgPath}, #{activeYn}, #{deletedYn})
  </insert>

  <update id="updateMenu" parameterType="com.meetlog.dto.Menu">
    UPDATE menu SET name=#{name}, price=#{price}, img_path=#{imgPath},
           active_yn=#{activeYn}, updated_at=NOW()
    WHERE id=#{id} AND company_id=#{companyId}
  </update>

  <update id="softDeleteMenu" parameterType="map">
    UPDATE menu SET deleted_yn='Y', updated_at=NOW()
    WHERE id=#{id} AND company_id=#{companyId}
  </update>

  <delete id="deleteMenuIngredients" parameterType="map">
    DELETE FROM menu_ingredient
    WHERE company_id=#{companyId} AND menu_id=#{menuId}
  </delete>

  <insert id="insertMenuIngredient" parameterType="com.meetlog.dto.MenuIngredient">
    INSERT INTO menu_ingredient (company_id, menu_id, material_id, qty)
    VALUES (#{companyId}, #{menuId}, #{materialId}, #{qty})
  </insert>

  <select id="listIngredientsOfMenu" parameterType="map" resultMap="MenuIngredientMap">
    SELECT mi.company_id, mi.menu_id, mi.material_id, mi.qty,
           m.name AS material_name, m.unit, m.unit_price
    FROM menu_ingredient mi
    JOIN material m ON m.company_id=mi.company_id AND m.id=mi.material_id
    WHERE mi.company_id=#{companyId} AND mi.menu_id=#{menuId}
    ORDER BY m.name
  </select>
</mapper>
