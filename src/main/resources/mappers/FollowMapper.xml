<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dao.FollowDAO">

    <!-- 팔로우 관계 생성 -->
    <insert id="followUser" parameterType="map">
        INSERT INTO follows (follower_id, following_id, created_at, is_active)
        VALUES (#{followerId}, #{followingId}, NOW(), true)
        ON DUPLICATE KEY UPDATE
            is_active = true,
            created_at = NOW()
    </insert>

    <!-- 팔로우 관계 삭제 (언팔로우) -->
    <update id="unfollowUser" parameterType="map">
        UPDATE follows 
        SET is_active = false, updated_at = NOW()
        WHERE follower_id = #{followerId} 
        AND following_id = #{followingId}
        AND is_active = true
    </update>

    <!-- 팔로우 관계 확인 -->
    <select id="isFollowing" parameterType="map" resultType="int">
        SELECT COUNT(*) 
        FROM follows 
        WHERE follower_id = #{followerId} 
        AND following_id = #{followingId}
        AND is_active = true
    </select>

    <!-- 사용자의 팔로워 목록 조회 -->
    <select id="getFollowers" parameterType="map" resultType="model.User">
        SELECT u.id, u.nickname, u.profile_image, u.level, u.follower_count, u.following_count
        FROM users u
        JOIN follows f ON u.id = f.follower_id
        WHERE f.following_id = #{userId}
        AND f.is_active = true
        AND u.is_active = true
        ORDER BY f.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 사용자의 팔로잉 목록 조회 -->
    <select id="getFollowing" parameterType="map" resultType="model.User">
        SELECT u.id, u.nickname, u.profile_image, u.level, u.follower_count, u.following_count
        FROM users u
        JOIN follows f ON u.id = f.following_id
        WHERE f.follower_id = #{userId}
        AND f.is_active = true
        AND u.is_active = true
        ORDER BY f.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 팔로워 수 조회 -->
    <select id="getFollowerCount" parameterType="int" resultType="int">
        SELECT COUNT(*) 
        FROM follows 
        WHERE following_id = #{userId}
        AND is_active = true
    </select>

    <!-- 팔로잉 수 조회 -->
    <select id="getFollowingCount" parameterType="int" resultType="int">
        SELECT COUNT(*) 
        FROM follows 
        WHERE follower_id = #{userId}
        AND is_active = true
    </select>

    <!-- 팔로우 관계 조회 -->
    <select id="getFollow" parameterType="map" resultType="model.Follow">
        SELECT * FROM follows 
        WHERE follower_id = #{followerId} 
        AND following_id = #{followingId}
        AND is_active = true
    </select>

    <!-- 사용자의 팔로우 피드용 팔로잉 목록 -->
    <select id="getFollowingIds" parameterType="int" resultType="int">
        SELECT following_id 
        FROM follows 
        WHERE follower_id = #{userId}
        AND is_active = true
    </select>

</mapper>
