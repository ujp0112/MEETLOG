<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="UserVectorMapper">

    <resultMap id="UserVectorResultMap" type="model.UserVectorRecord">
        <id property="userId" column="user_id" />
        <result property="vectorJson" column="vector_json" />
        <result property="status" column="status" />
        <result property="updatedAt" column="updated_at" />
        <result property="lastError" column="last_error" />
    </resultMap>

    <select id="findByUserId" parameterType="int" resultMap="UserVectorResultMap">
        SELECT user_id, vector_json, status, updated_at, last_error
        FROM user_preference_vectors
        WHERE user_id = #{userId}
    </select>

    <insert id="markProcessing" parameterType="int">
        INSERT INTO user_preference_vectors (user_id, status, updated_at, last_error)
        VALUES (#{userId}, 'PROCESSING', NOW(), NULL)
        ON DUPLICATE KEY UPDATE
            status = 'PROCESSING',
            last_error = NULL,
            updated_at = NOW()
    </insert>

    <insert id="upsertVector" parameterType="map">
        INSERT INTO user_preference_vectors (user_id, vector_json, status, updated_at, last_error)
        VALUES (#{userId}, #{vectorJson}, 'READY', NOW(), NULL)
        ON DUPLICATE KEY UPDATE
            vector_json = VALUES(vector_json),
            status = 'READY',
            updated_at = NOW(),
            last_error = NULL
    </insert>

    <insert id="markEmpty" parameterType="int">
        INSERT INTO user_preference_vectors (user_id, vector_json, status, updated_at, last_error)
        VALUES (#{userId}, NULL, 'EMPTY', NOW(), NULL)
        ON DUPLICATE KEY UPDATE
            vector_json = NULL,
            status = 'EMPTY',
            updated_at = NOW(),
            last_error = NULL
    </insert>

    <insert id="markFailure" parameterType="map">
        INSERT INTO user_preference_vectors (user_id, vector_json, status, updated_at, last_error)
        VALUES (#{userId}, NULL, 'FAILED', NOW(), #{error})
        ON DUPLICATE KEY UPDATE
            status = 'FAILED',
            last_error = #{error},
            updated_at = NOW()
    </insert>

</mapper>
